{% extends "admin_dashboard.html" %}

{% block content %}
<div class="table-container">
    <h2 class="mb-4">Quản lý Người dùng</h2>

    <div class="card p-3 mb-4 bg-light">
        <h5 class="mb-3">➕ Thêm User Mới</h5>
        <form id="add-user-form" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label" for="new-username">Username <span class="text-danger">*</span></label>
                <input type="text" class="form-control form-control-sm" id="new-username" required>
            </div>
            <div class="col-md-3">
                <label class="form-label" for="new-email">Email <span class="text-danger">*</span></label>
                <input type="email" class="form-control form-control-sm" id="new-email" required>
            </div>
            <div class="col-md-2">
                <label class="form-label" for="new-password">Password <span class="text-danger">*</span></label>
                <input type="password" class="form-control form-control-sm" id="new-password" required>
            </div>
            
            <hr class="my-3">
            
            <div class="col-md-2">
                <label class="form-label" for="new-address">Address</label>
                <input type="text" class="form-control form-control-sm" id="new-address">
            </div>
            <div class="col-md-2">
                <label class="form-label" for="new-phone">Phone</label>
                <input type="text" class="form-control form-control-sm" id="new-phone">
            </div>
            <div class="col-md-2">
                <label class="form-label" for="new-dob">Date of Birth</label>
                <input type="date" class="form-control form-control-sm" id="new-dob">
            </div>

            <div class="col-md-2">
                <label class="form-label" for="new-role">Role <span class="text-danger">*</span></label>
                <select class="form-select form-select-sm" id="new-role" required>
                    <option value="" disabled selected>Chọn Role</option>
                    <option value="user">user</option>
                    <option value="therapist">therapist</option>
                    <option value="admin">admin</option>
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label" for="new-gold">Gold</label>
                <input type="number" class="form-control form-control-sm" id="new-gold" value="200">
            </div>
            <div class="col-md-3">
                <label class="form-label" for="new-tags">Tags</label>
                <input type="text" class="form-control form-control-sm" id="new-tags" placeholder="e.g., Depression, Stress">
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-success btn-sm w-100">Thêm User</button>
            </div>
        </form>
    </div>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Tags</th>
                <th>Gold</th>
                <th>Address</th>
                <th>Phone</th>
                <th>DOB</th>
                <th>Date Joined</th>
                <th>Mật khẩu đã Hash (DB)</th>
                <th>Mật khẩu mới</th>
                <th>Thao tác</th> 
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                
                <td>
                    <select class="form-select form-select-sm" id="role-{{ user.id }}">
                        <option value="user" {% if user.role == 'user' %}selected{% endif %}>user</option>
                        <option value="therapist" {% if user.role == 'therapist' %}selected{% endif %}>therapist</option>
                        <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>admin</option>
                    </select>
                </td>
                
                <td><input type="text" class="form-control form-control-sm" id="tags-{{ user.id }}" value="{{ user.tags if user.tags is not none else '' }}"></td>
                <td><input type="number" class="form-control form-control-sm" id="gold-{{ user.id }}" value="{{ user.gold }}"></td>
                
                <td>{{ user.address if user.address is not none else 'N/A' }}</td>
                <td>{{ user.phone if user.phone is not none else 'N/A' }}</td>
                <td>{{ user.date_of_birth if user.date_of_birth is not none else 'N/A' }}</td>
                <td>{{ user.date_joined|string|truncate(10, True, '') }}</td>
                
                <td>
                    <small id="password-hash-{{ user.id }}" class="text-muted" style="max-width: 150px; display: inline-block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; cursor: pointer;" 
                           title="Click để xem toàn bộ hash"
                           onclick="showFullHash('{{ user.id }}')">
                        Đang tải...
                    </small>
                </td>

                <td>
                    <input type="password" class="form-control form-control-sm" id="password-{{ user.id }}" placeholder="Để trống nếu không đổi">
                </td>

                <td style="min-width: 120px;">
                    <button class="btn btn-sm btn-primary w-100 mb-1" onclick="updateUser('{{ user.id }}')">LƯU CẬP NHẬT</button>
                    <button class="btn btn-sm btn-danger w-100" onclick="deleteUser('{{ user.id }}', '{{ user.username }}')">XÓA</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // --- LOGIC THÊM USER MỚI (CẬP NHẬT) ---
    document.getElementById('add-user-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('new-username').value.trim();
        const email = document.getElementById('new-email').value.trim();
        const password = document.getElementById('new-password').value.trim();
        
        // Lấy dữ liệu bắt buộc (Role) và tùy chọn
        const role = document.getElementById('new-role').value;
        const address = document.getElementById('new-address').value.trim();
        const phone = document.getElementById('new-phone').value.trim();
        const date_of_birth = document.getElementById('new-dob').value.trim();
        const gold = document.getElementById('new-gold').value.trim();
        const tags = document.getElementById('new-tags').value.trim();


        if (!username || !email || !password || !role) { // Thêm role vào kiểm tra bắt buộc
            alert("Vui lòng nhập Username, Email, Password, và Role (các trường có *).");
            return;
        }

        fetch('/api/admin/add_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                username: username, 
                email: email, 
                password: password, 
                role: role, 
                tags: tags,
                gold: gold,
                address: address, 
                phone: phone,     
                date_of_birth: date_of_birth 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload(); 
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Lỗi khi gửi yêu cầu API.');
        });
    });

    // --- LOGIC XÓA USER (GIỮ NGUYÊN) ---
    function deleteUser(userId, username) {
        if (confirm(`CẢNH BÁO: Bạn có chắc chắn muốn xóa user "${username}" (ID: ${userId}) không? Hành động này sẽ xóa TẤT CẢ dữ liệu liên quan và không thể hoàn tác!`)) {
            fetch(`/api/admin/delete_user/${userId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload(); 
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Lỗi khi gửi yêu cầu API xóa.');
            });
        }
    }

    // --- LOGIC TẢI/CẬP NHẬT/HIỂN THỊ HASH (GIỮ NGUYÊN) ---

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.table tbody tr').forEach(row => {
            const selectElement = row.querySelector('select[id^="role-"]');
            if (selectElement) { // Đảm bảo phần tử tồn tại
                 const userId = selectElement.id.replace('role-', '');
                 loadPasswordHash(userId);
            }
        });
    });

    function loadPasswordHash(userId) {
        fetch(`/api/admin/get_user_password/${userId}`)
        .then(response => response.json())
        .then(data => {
            const hashElement = document.getElementById(`password-hash-${userId}`);
            if (data.success && hashElement) {
                hashElement.innerText = data.password_hash;
                hashElement.title = data.password_hash;
            } else if (hashElement) {
                hashElement.innerText = 'Lỗi tải';
            }
        })
        .catch(error => {
            const hashElement = document.getElementById(`password-hash-${userId}`);
            if (hashElement) hashElement.innerText = 'Lỗi kết nối';
        });
    }

    function showFullHash(userId) {
        const hashElement = document.getElementById(`password-hash-${userId}`);
        if (hashElement && hashElement.innerText.includes('$')) {
            alert(`Mật khẩu đã Hash (giá trị thực trong DB):\n${hashElement.title}`);
        }
    }

    function updateUser(userId) {
        const id = parseInt(userId);
        
        if (isNaN(id)) {
            alert("Lỗi: Không tìm thấy User ID hợp lệ.");
            return;
        }

        const role = document.getElementById(`role-${id}`).value;
        const tags = document.getElementById(`tags-${id}`).value;
        const gold = document.getElementById(`gold-${id}`).value;
        const password = document.getElementById(`password-${id}`).value.trim();

        const validRoles = ['user', 'therapist', 'admin'];
        if (!validRoles.includes(role)) {
            alert("Lỗi: Role không hợp lệ.");
            return;
        }

        fetch('/api/admin/update_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                id: id, 
                role: role, 
                tags: tags, 
                gold: gold, 
                password: password
            }) 
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                document.getElementById(`password-${id}`).value = '';
                
                if (password) { 
                    loadPasswordHash(id); 
                }
                window.location.reload(); 
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Lỗi khi gửi yêu cầu API.');
        });
    }
</script>
{% endblock %}