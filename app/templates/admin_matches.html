{% extends "admin_dashboard.html" %}

{% block content %}
<div class="table-container mb-4">
    <h2 class="mb-4">Quản lý Matchmaking Results</h2>

    <div class="card p-3 mb-4 bg-light">
        <h5 class="mb-3">Tạo Match Thủ Công</h5>
        <form id="add-match-form">
            <div class="row g-3">
                <div class="col-md-5">
                    <label for="student-id" class="form-label">ID Sinh viên (Student ID)</label>
                    <input type="number" class="form-control" id="student-id" required>
                    <small class="form-text text-muted">Kiểm tra ID trong danh sách User bên dưới.</small>
                </div>
                <div class="col-md-5">
                    <label for="therapist-id" class="form-label">ID Tư vấn viên (Therapist ID)</label>
                    <input type="number" class="form-control" id="therapist-id" required>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">Tạo Match</button>
                </div>
            </div>
        </form>
    </div>

    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>Room Code</th>
                <th>Student ID</th>
                <th>Therapist ID</th>
                <th>Matched At</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody>
            {% for match in matches %}
            <tr>
                <td>{{ match.id }}</td>
                <td><strong>{{ match.roomcode }}</strong></td>
                <td>{{ match.student_user_id }}</td>
                <td>{{ match.therapist_user_id }}</td>
                <td>{{ match.matched_at }}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteMatch('{{ match.roomcode }}')">Xóa Kết Nối</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <hr>
    <h5 class="mt-4">Danh sách User để tham khảo ID:</h5>
    <table class="table table-sm table-bordered">
        <thead>
            <tr><th>ID</th><th>Username</th><th>Role</th></tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr><td>{{ user.id }}</td><td>{{ user.username }}</td><td>{{ user.role }}</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    document.getElementById('add-match-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const studentId = document.getElementById('student-id').value;
        const therapistId = document.getElementById('therapist-id').value;

        fetch('/api/admin/add_match', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id: studentId, therapist_id: therapistId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload(); 
            } else {
                alert('Lỗi: ' + data.message);
            }
        });
    });

    function deleteMatch(roomCode) {
        if (!confirm(`Bạn có chắc chắn muốn xóa Match Room Code: ${roomCode} không?`)) {
            return;
        }

        fetch(`/api/admin/delete_match/${roomCode}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload(); 
            } else {
                alert('Lỗi: ' + data.message);
            }
        });
    }
</script>
{% endblock %}