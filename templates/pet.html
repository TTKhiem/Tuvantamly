<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Virtual Pet</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for smooth transitions */
        #pet {
            /* This is our pet character */
            width: 50px;
            height: 50px;
            background-color: #fdba74; /* A friendly orange */
            border: 3px solid #f97316;
            border-radius: 50%;
            position: absolute;
            /* Start in the middle */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* This makes the movement smooth */
            transition: all 1.5s ease-in-out;
            
            /* Simple face */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
            color: #f97316;
        }

        #speech-bubble {
            /* This makes the triangle for the speech bubble */
            position: absolute;
            background: white;
            border-radius: .4em;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            
            /* REMOVED: bottom: 120%; */
            /* REMOVED: left: 50%; */
            /* We will now control position with JavaScript */
            
            transform: translateX(-50%); /* This still centers it */
            width: 200px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, top 1.5s ease-in-out, left 1.5s ease-in-out; /* Add position to transition */
            pointer-events: none; /* Don't let it block clicks */
        }

        #speech-bubble.visible {
            opacity: 1;
        }

        #speech-bubble::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-top-color: white;
            border-bottom: 0;
            margin-left: -10px;
            margin-bottom: -10px;
        }

        /* Stat bar transitions */
        .stat-bar-inner {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex items-center justify-center min-h-screen">

    <main class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">My Companion</h1>
        
        <!-- Pet's Name (from Flask) -->
        <h2 class="text-xl font-semibold text-gray-700">
            Name: <span id="pet-name" class="text-orange-500">{{ pet_name }}</span>
        </h2>
        
        <!-- Stats -->
        <div class="space-y-3 mt-4">
            <!-- Happiness Bar -->
            <div>
                <label for="happiness" class="block text-sm font-medium text-gray-700">Happiness ðŸ’–</label>
                <div class="w-full bg-gray-200 rounded-full h-4 mt-1 overflow-hidden">
                    <div id="happiness-bar" class="stat-bar-inner bg-pink-400 h-4 rounded-full" style="width: 50%"></div>
                </div>
                <span id="happiness-text" class="text-xs text-gray-600">50/100</span>
            </div>
            <!-- Energy Bar -->
            <div>
                <label for="energy" class="block text-sm font-medium text-gray-700">Energy âš¡</label>
                <div class="w-full bg-gray-200 rounded-full h-4 mt-1 overflow-hidden">
                    <div id="energy-bar" class="stat-bar-inner bg-yellow-400 h-4 rounded-full" style="width: 100%"></div>
                </div>
                <span id="energy-text" class="text-xs text-gray-600">100/100</span>
            </div>
        </div>

        <!-- The "Small Box" for the pet -->
        <div id="pet-container" class="w-full h-64 bg-green-100 border-4 border-green-300 rounded-lg mt-6 relative overflow-hidden">
            <!-- The Pet -->
            <!-- The face is just a simple text emoji-like thing :) -->
            <div id="pet">^_^</div>

            <!-- The Speech Bubble -->
            <div id="speech-bubble" class="text-sm text-gray-700">
                A motivational quote!
            </div>
        </div>
    </main>

    <script>
        // Wait for the DOM to be fully loaded before running scripts
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Element Selectors ---
            const petElement = document.getElementById('pet');
            const petContainer = document.getElementById('pet-container');
            const speechBubble = document.getElementById('speech-bubble');
            const happinessBar = document.getElementById('happiness-bar');
            const energyBar = document.getElementById('energy-bar');
            const happinessText = document.getElementById('happiness-text');
            const energyText = document.getElementById('energy-text');

            // --- State ---
            let currentPetX = 50; // %
            let currentPetY = 50; // %
            let speechBubbleTimer; // To hide the bubble after a bit

            // --- Functions ---

            /**
             * Updates the Happiness and Energy UI
             */
            function updateStatsUI(happiness, energy) {
                // Update Happiness
                happinessBar.style.width = `${happiness}%`;
                happinessText.textContent = `${happiness}/100`;

                // Update Energy
                energyBar.style.width = `${energy}%`;
                energyText.textContent = `${energy}/100`;
            }

            /**
             * Fetches the pet's initial stats when the page loads
             */
            async function fetchInitialStats() {
                try {
                    const response = await fetch('/api/pet/stats');
                    if (!response.ok) throw new Error('Could not fetch stats');
                    const stats = await response.json();
                    updateStatsUI(stats.happiness, stats.energy);
                } catch (error) {
                    console.error('Error fetching initial stats:', error);
                }
            }

            /**
             * Positions the speech bubble directly above the pet element
             */
            function positionSpeechBubble() {
                // petElement.style.top is in %, so we use offsetTop to get pixels
                const petTop = petElement.offsetTop;
                const petLeft = petElement.offsetLeft;
                const petWidth = petElement.offsetWidth;

                // Position bubble 10px above the pet, centered
                speechBubble.style.top = `${petTop - speechBubble.offsetHeight - 10}px`;
                speechBubble.style.left = `${petLeft + (petWidth / 2)}px`;
            }

            /**
             * Shows a message in the speech bubble for a set duration
             */
            function showQuote(text, duration = 5000) {
                console.log('Showing quote:', text);
                // If a bubble is already shown, clear its timer
                if (speechBubbleTimer) {
                    clearTimeout(speechBubbleTimer);
                }
                
                speechBubble.textContent = text;
                
                // *** NEW: Position the bubble before showing it ***
                positionSpeechBubble();
                
                speechBubble.classList.add('visible');

                // Set a timer to hide the bubble
                speechBubbleTimer = setTimeout(() => {
                    speechBubble.classList.remove('visible');
                    speechBubbleTimer = null;
                }, duration);
            }

            /**
             * Moves the pet based on a direction string
             */
            function movePet(direction) {
                console.log('Moving pet:', direction);
                const moveAmount = 30; // How many % to move

                // Calculate new positions
                let newX = currentPetX;
                let newY = currentPetY;

                if (direction.includes('left')) newX -= moveAmount;
                if (direction.includes('right')) newX += moveAmount;
                if (direction.includes('up')) newY -= moveAmount;
                if (direction.includes('down')) newY += moveAmount;

                // Clamp values to stay inside the box (10% to 90%)
                currentPetX = Math.max(10, Math.min(90, newX));
                currentPetY = Math.max(10, Math.min(90, newY));

                // Apply the new position using 'top' and 'left'
                petElement.style.left = `${currentPetX}%`;
                petElement.style.top = `${currentPetY}%`;

                // *** NEW: If the bubble is visible, move it with the pet ***
                if (speechBubble.classList.contains('visible')) {
                    positionSpeechBubble();
                }
            }

            /**
             * The main loop to get the pet's next action
             */
            async function petActionLoop() {
                try {
                    const response = await fetch('/api/pet/action');
                    if (!response.ok) throw new Error('Could not fetch action');
                    
                    const actionData = await response.json();

                    // Update stats first, as every action returns them
                    updateStatsUI(actionData.happiness, actionData.energy);

                    // Handle the specific action
                    switch (actionData.action) {
                        case 'motivate':
                            showQuote(actionData.quote);
                            break;
                        case 'wander':
                            movePet(actionData.direction);
                            break;
                        case 'rest':
                            showQuote('Zzz...', 5000); // Show a short "Zzz"
                            break;
                    }

                } catch (error) {
                    console.error('Error in pet action loop:', error);
                    // Maybe show an error to the user in the bubble
                    showQuote('Hmm, I feel a bit lost...', 5000);
                }
            }

            // --- Initial Setup ---
            fetchInitialStats();
            
            // Run the pet action loop every 7 seconds (between 5-10s)
            setInterval(petActionLoop, 7000);
        });
    </script>
</body>
</html>