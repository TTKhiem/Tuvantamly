<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the pet and dashboard */
        body {
            font-family: 'Inter', sans-serif;
        }

        .stat-bar-inner {
            transition: width 0.5s ease-in-out;
        }

        #pet {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 1.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* Pet evolution styles */
        .stage-1 {
            background-color: #fdba74;
            border: 3px solid #f97316;
            color: #f97316;
        }

        .stage-2 {
            background-color: #93c5fd;
            border: 4px solid #3b82f6;
            color: #3b82f6;
            box-shadow: 0 0 10px #93c5fd;
        }

        .stage-3 {
            width: 60px;
            height: 60px;
            background-color: #fca5a5;
            border: 4px solid #ef4444;
            color: #ef4444;
            border-radius: 40%;
            font-size: 1.5rem;
            box-shadow: 0 0 15px #fca5a5;
        }

        @keyframes levelUpAnimation {
            0% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 15px yellow
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                box-shadow: 0 0 30px yellow
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: none
            }
        }

        .level-up-animation {
            animation: levelUpAnimation 1s ease-in-out
        }

        #speech-bubble {
            position: absolute;
            background: #E5E7EB;
            color: #1F2937;
            /* Dark text on light bubble */
            border-radius: .4em;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateX(-50%);
            width: 200px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, top 1.5s ease-in-out, left 1.5s ease-in-out;
            pointer-events: none;
            z-index: 10;
        }

        #speech-bubble.visible {
            opacity: 1;
        }

        #speech-bubble::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-top-color: #E5E7EB;
            /* Match bubble background */
            border-bottom: 0;
            margin-left: -10px;
            margin-bottom: -10px;
        }

        /* Tab styles */
        .tab-button {
            transition: all 0.2s ease;
        }

        .tab-button.active {
            border-color: #3b82f6;
            color: #60a5fa;
            background-color: rgba(59, 130, 246, 0.1);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Quest/Shop styles */
        .item-card {
            transition: all 0.2s ease-in-out;
        }

        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .item-card-icon {
            font-size: 3rem;
            line-height: 1;
        }

        /* Modal Styles */
        #quest-modal-overlay,
        #chat-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease-in-out;
            z-index: 50;
        }

        #breathing-circle {
            transition: transform 3s ease-in-out;
        }

        .hidden {
            display: none;
        }

        /* CSS M·ªöI CHO CHATBOT */
        .chat-message-container {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .chat-message-container.user {
            justify-content: flex-end;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-300">

    <div class="container mx-auto p-4 max-w-4xl">

        <header class="flex justify-between items-center bg-gray-800 p-4 rounded-lg shadow-md mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-200">Ch√†o, <span class="text-blue-400">{{ username }}</span>!</h1>
                <p class="text-sm text-gray-400">ƒê√¢y l√† trang qu·∫£n l√Ω pet v√† nhi·ªám v·ª• c·ªßa b·∫°n.</p>
            </div>
            <a href="{{ url_for('home') }}" class="text-sm text-blue-400 hover:underline">&larr; Quay v·ªÅ Trang ch·ªß</a>
        </header>

        <div class="bg-gray-800 p-6 rounded-lg shadow-md">

            <!-- Tabs Navigation -->
            <div class="border-b border-gray-700 mb-6">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button data-tab="pet" class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-400 hover:text-gray-200 hover:border-gray-500">B·∫°n ƒê·ªìng H√†nh</button>
                    <button data-tab="quests" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-400 hover:text-gray-200 hover:border-gray-500">Nhi·ªám V·ª•</button>
                    <button data-tab="shop" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-400 hover:text-gray-200 hover:border-gray-500">C·ª≠a H√†ng</button>
                    <button data-tab="inventory" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-400 hover:text-gray-200 hover:border-gray-500">T√∫i ƒê·ªì</button>
                </nav>
            </div>

            <!-- Tabs Content -->
            <div>
                <!-- Pet Panel -->
                <div id="panel-pet" class="tab-panel active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <!-- Pet Display -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-200 mb-2" id="pet-name">ƒêang t·∫£i...</h3>
                            <div id="pet-container" class="w-full h-80 bg-green-100 border-4 border-green-300 rounded-lg relative overflow-hidden shadow-inner">
                                <div id="pet">(‚Ä¢_‚Ä¢)</div>
                                <div id="speech-bubble" class="text-sm">...</div>
                            </div>
                        </div>

                        <!-- Pet Stats and Actions -->
                        <div class="space-y-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-200">Th√¥ng s·ªë</h3>
                                <div class="space-y-3 mt-2">
                                    <div class="text-sm font-medium">C·∫•p ƒë·ªô: <span id="level-text" class="text-blue-400 font-bold">1</span> (<span id="exp-text">0/100</span>)</div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300">H·∫°nh ph√∫c üíñ</label>
                                        <div class="w-full bg-gray-700 rounded-full h-4 mt-1 overflow-hidden">
                                            <div id="happiness-bar" class="stat-bar-inner bg-pink-500 h-4 rounded-full" style="width: 50%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300">NƒÉng l∆∞·ª£ng ‚ö°</label>
                                        <div class="w-full bg-gray-700 rounded-full h-4 mt-1 overflow-hidden">
                                            <div id="energy-bar" class="stat-bar-inner bg-yellow-400 h-4 rounded-full" style="width: 100%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-lg font-semibold text-gray-200">H√†nh ƒë·ªông</h3>
                                <p class="text-sm text-gray-400 mb-3">T∆∞∆°ng t√°c v·ªõi pet c·ªßa b·∫°n!</p>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                    <button id="btn-feed" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">Cho ƒÉn (10 V√†ng)</button>
                                    <button id="btn-play" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">Ch∆°i</button>
                                    <button id="btn-chat" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">Tr√≤ chuy·ªán</button>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-lg font-semibold text-gray-200">Tr·∫°ng th√°i</h3>
                                <p class="text-md text-gray-300 mt-2">T√¢m tr·∫°ng: <span id="mood-text" class="font-semibold text-indigo-400">Vui v·∫ª üòä</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quests Panel -->
                <div id="panel-quests" class="tab-panel">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-200">Nhi·ªám v·ª• H√†ng ng√†y</h3>
                        <p class="text-sm text-gray-400">Ho√†n th√†nh ƒë·ªÉ nh·∫≠n EXP v√† V√†ng!</p>
                    </div>
                    <div id="quest-list" class="space-y-3">
                        <p class="text-gray-500">ƒêang t·∫£i nhi·ªám v·ª•...</p>
                    </div>
                </div>

                <!-- Shop Panel -->
                <div id="panel-shop" class="tab-panel">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-200">C·ª≠a H√†ng</h3>
                        <p class="text-sm text-gray-400">V√†ng c·ªßa b·∫°n: <span id="gold-text-shop" class="font-bold text-yellow-400">0</span></p>
                    </div>
                    <div id="shop-list" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <p class="text-gray-500">ƒêang t·∫£i v·∫≠t ph·∫©m...</p>
                    </div>
                </div>

                <!-- Inventory Panel -->
                <div id="panel-inventory" class="tab-panel">
                    <h3 class="text-xl font-semibold text-gray-200 mb-4">T√∫i ƒê·ªì</h3>
                    <div id="inventory-list" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <p class="text-gray-500">T√∫i ƒë·ªì c·ªßa b·∫°n tr·ªëng tr∆°n.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Quest Modal -->
    <div id="quest-modal-overlay" class="hidden flex items-center justify-center">
        <div class="bg-gray-800 border border-gray-700 p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-xl font-bold text-white">Quest Title</h2>
                <button id="modal-close-button" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="text-gray-300"></div>
        </div>
    </div>

    <!-- Chatbot Modal -->
    <div id="chat-modal-overlay" class="hidden flex items-center justify-center">
        <div class="bg-gray-800 border border-gray-700 p-0 rounded-xl shadow-2xl w-full max-w-lg mx-4 flex flex-col h-[70vh]">
            <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                <h2 id="chat-modal-title" class="text-xl font-bold text-white">Tr√≤ chuy·ªán</h2>
                <button id="chat-close-button" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="chat-log" class="flex-grow p-4 space-y-4 overflow-y-auto flex flex-col"></div>
            <div class="p-4 border-t border-gray-700 flex items-center flex-shrink-0">
                <input type="text" id="chat-input" class="w-full p-2 bg-gray-700 border border-gray-600 text-white rounded-md focus:ring-2 focus:ring-purple-500" placeholder="N√≥i g√¨ ƒë√≥ v·ªõi pet...">
                <button id="chat-send-button" class="ml-2 px-4 py-2 text-white font-bold bg-purple-600 hover:bg-purple-700 rounded-md transition-colors">G·ª≠i</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE VARIABLES ---
            let speechBubbleTimer, currentPetX = 50,
                currentPetY = 50,
                previousLevel = 1,
                activeInteractiveQuest = null;

            // --- DOM ELEMENTS ---
            const petElement = document.getElementById('pet');
            const petContainer = document.getElementById('pet-container');
            const speechBubble = document.getElementById('speech-bubble');
            const happinessBar = document.getElementById('happiness-bar');
            const energyBar = document.getElementById('energy-bar');
            const levelText = document.getElementById('level-text');
            const expText = document.getElementById('exp-text');
            const petNameText = document.getElementById('pet-name');
            const moodText = document.getElementById('mood-text');
            const questList = document.getElementById('quest-list');
            const shopList = document.getElementById('shop-list');
            const inventoryList = document.getElementById('inventory-list');
            const goldTextShop = document.getElementById('gold-text-shop');
            const btnFeed = document.getElementById('btn-feed');
            const btnPlay = document.getElementById('btn-play');
            const btnChat = document.getElementById('btn-chat');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');

            // Quest Modal Elements
            const modalOverlay = document.getElementById('quest-modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalCloseButton = document.getElementById('modal-close-button');

            // Chat Modal Elements
            const chatModalOverlay = document.getElementById('chat-modal-overlay');
            const chatModalTitle = document.getElementById('chat-modal-title');
            const chatLog = document.getElementById('chat-log');
            const chatInput = document.getElementById('chat-input');
            const chatSendButton = document.getElementById('chat-send-button');
            const chatCloseButton = document.getElementById('chat-close-button');

            // --- API HELPERS ---
            const api = {
                getGameData: () => safeFetch('/api/game_data'),
                petAction: () => safeFetch('/api/pet/action'),
                feedPet: () => safeFetch('/api/pet/feed', { method: 'POST' }),
                playWithPet: () => safeFetch('/api/pet/play', { method: 'POST' }),
                startQuest: (id) => safeFetch(`/api/start_quest/${id}`),
                completeQuest: (id) => safeFetch(`/api/complete_quest/${id}`, { method: 'POST' }),
                getShopItems: () => safeFetch('/api/shop/items'),
                buyItem: (id) => safeFetch(`/api/shop/buy/${id}`, { method: 'POST' }),
                petChat: (message) => safeFetch('/api/pet/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                }),
            };

            async function safeFetch(url, options = {}) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || `HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('API Error:', error.message);
                    showToast(error.message, 'error');
                }
            }

            // --- RENDER FUNCTIONS ---
            function renderPet(pet) {
                if (!pet) return;
                if (pet.level > previousLevel) {
                    petElement.classList.add('level-up-animation');
                    setTimeout(() => petElement.classList.remove('level-up-animation'), 1000);
                }
                previousLevel = pet.level;
                happinessBar.style.width = `${pet.happiness}%`;
                energyBar.style.width = `${pet.energy}%`;
                levelText.textContent = pet.level;
                expText.textContent = `${pet.experience}/${pet.exp_to_next_level} EXP`;
                petNameText.textContent = pet.name;
                moodText.textContent = pet.mood;
                const appearance = pet.appearance;
                if (appearance && appearance.css_class && appearance.face) {
                    petElement.className = '';
                    petElement.classList.add(appearance.css_class);
                    petElement.textContent = appearance.face;
                } else {
                    petElement.textContent = '(‚Ä¢_‚Ä¢)';
                }
            }

            function renderQuests(quests) {
                questList.innerHTML = '';
                if (!quests || quests.length === 0) {
                    questList.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ nhi·ªám v·ª• n√†o h√¥m nay. Quay l·∫°i sau nh√©!</p>';
                    return;
                }
                quests.forEach(q => {
                    const questEl = document.createElement('div');
                    questEl.className = 'flex items-center justify-between p-4 bg-gray-700 rounded-lg border border-gray-600';
                    let actionHtml;
                    const isCompleted = q.completed;
                    if (isCompleted) {
                        actionHtml = `<span class="py-1 px-4 text-sm font-semibold text-gray-400 bg-gray-800 rounded-full cursor-not-allowed">Done</span>`;
                    } else if (q.type === 'simple') {
                        actionHtml = `<button data-quest-id="${q.id}" class="btn-complete-quest text-sm font-medium py-2 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white">Ho√†n th√†nh</button>`;
                    } else {
                        actionHtml = `<button data-quest-id="${q.id}" class="btn-start-quest text-sm font-medium py-2 px-4 rounded-lg bg-purple-600 hover:bg-purple-700 text-white">B·∫Øt ƒë·∫ßu</button>`;
                    }
                    questEl.innerHTML = `
                        <div>
                            <p class="font-medium ${isCompleted ? 'line-through text-gray-500' : 'text-gray-200'}">${q.title}</p>
                            <p class="text-sm text-green-400">+${q.reward_exp} EXP, +${q.reward_gold} V√†ng</p>
                        </div>
                        ${actionHtml}`;
                    questList.appendChild(questEl);
                });
            }

            async function renderShop() {
                const items = await api.getShopItems();
                shopList.innerHTML = '';
                if (!items || items.length === 0) {
                    shopList.innerHTML = '<p class="text-gray-500">C·ª≠a h√†ng ƒëang ƒë√≥ng c·ª≠a!</p>';
                    return;
                }
                items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'item-card border border-gray-700 rounded-lg p-4 text-center bg-gray-700 shadow-sm';
                    itemEl.innerHTML = `
                        <div class="item-card-icon">${item.icon}</div>
                        <p class="font-semibold mt-2 text-gray-200">${item.name}</p>
                        <p class="text-sm text-gray-400">${item.type === 'food' ? `+${item.value} H·∫°nh ph√∫c` : 'Trang tr√≠'}</p>
                        <button data-item-id="${item.id}" class="btn-buy-item mt-3 w-full bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-bold py-2 px-3 rounded"> Mua (${item.price} V√†ng) </button>`;
                    shopList.appendChild(itemEl);
                });
            }

            function renderInventory(inventory) {
                inventoryList.innerHTML = '';
                if (!inventory || inventory.length === 0) {
                    inventoryList.innerHTML = '<p class="text-gray-500">T√∫i ƒë·ªì c·ªßa b·∫°n tr·ªëng tr∆°n.</p>';
                    return;
                }
                inventory.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'border border-gray-700 rounded-lg p-4 text-center bg-gray-700';
                    itemEl.innerHTML = `
                        <div class="item-card-icon">${item.icon}</div>
                        <p class="font-semibold text-gray-200 mt-2">${item.name}</p>
                        <p class="text-sm text-gray-400">${item.type}</p>`;
                    inventoryList.appendChild(itemEl);
                });
            }

            function renderGold(gold) {
                goldTextShop.textContent = gold;
            }

            // --- UI & PET INTERACTION ---
            function showPetQuote(text, duration = 4000) {
                if (speechBubbleTimer) clearTimeout(speechBubbleTimer);
                speechBubble.textContent = text;
                positionSpeechBubble();
                speechBubble.classList.add('visible');
                speechBubbleTimer = setTimeout(() => speechBubble.classList.remove('visible'), duration);
            }

            function positionSpeechBubble() {
                const petTop = petElement.offsetTop;
                const petLeft = petElement.offsetLeft;
                const petWidth = petElement.offsetWidth;
                speechBubble.style.top = `${petTop - speechBubble.offsetHeight - 10}px`;
                speechBubble.style.left = `${petLeft + (petWidth / 2)}px`;
            }

            function movePet(direction) {
                const moveAmount = 30;
                let newX = currentPetX,
                    newY = currentPetY;
                if (direction.includes('left')) newX -= moveAmount;
                if (direction.includes('right')) newX += moveAmount;
                if (direction.includes('up')) newY -= moveAmount;
                if (direction.includes('down')) newY += moveAmount;
                currentPetX = Math.max(10, Math.min(90, newX));
                currentPetY = Math.max(10, Math.min(90, newY));
                petElement.style.left = `${currentPetX}%`;
                petElement.style.top = `${currentPetY}%`;
                if (speechBubble.classList.contains('visible')) {
                    positionSpeechBubble();
                }
            }

            async function loadGameData() {
                const data = await api.getGameData();
                if (data) {
                    renderPet(data.pet);
                    renderQuests(data.quests);
                    renderInventory(data.inventory);
                    renderGold(data.gold);
                }
            }

            async function petActionLoop() {
                const data = await api.petAction();
                if (data) {
                    renderPet(data);
                    switch (data.action) {
                        case 'motivate':
                            showPetQuote(data.quote);
                            break;
                        case 'wander':
                            movePet(data.direction);
                            break;
                        case 'rest':
                            showPetQuote(data.quote || 'Zzz...', 3000);
                            break;
                    }
                }
            }

            // --- EVENT HANDLERS ---
            async function handleFeedClick() {
                const data = await api.feedPet();
                if (data) {
                    renderPet(data.pet);
                    renderGold(data.gold);
                    showToast('Pet ƒë√£ ƒë∆∞·ª£c cho ƒÉn!', 'success');
                }
            }

            async function handlePlayClick() {
                const data = await api.playWithPet();
                if (data) {
                    renderPet(data.pet);
                    showToast('B·∫°n ƒë√£ ch∆°i v·ªõi pet!', 'success');
                }
            }

            async function handleQuestListClick(e) {
                const completeButton = e.target.closest('.btn-complete-quest');
                const startButton = e.target.closest('.btn-start-quest');
                if (completeButton) {
                    const questId = completeButton.dataset.questId;
                    const data = await api.completeQuest(questId);
                    if (data) {
                        renderPet(data.pet);
                        renderQuests(data.quests);
                        renderGold(data.gold);
                        showToast('ƒê√£ ho√†n th√†nh nhi·ªám v·ª•!', 'success');
                    }
                } else if (startButton) {
                    const questId = startButton.dataset.questId;
                    await startInteractiveQuest(questId);
                }
            }

            async function handleBuyItemClick(e) {
                if (!e.target.matches('.btn-buy-item')) return;
                const itemId = e.target.dataset.itemId;
                if (!itemId) return;
                const data = await api.buyItem(itemId);
                if (data) {
                    renderInventory(data.inventory);
                    renderGold(data.gold);
                    showToast(data.message || 'Mua v·∫≠t ph·∫©m th√†nh c√¥ng!', 'success');
                }
            }

            function handleTabClick(e) {
                const clickedTab = e.target.closest('.tab-button');
                if (!clickedTab) return;
                const tabId = clickedTab.dataset.tab;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabPanels.forEach(panel => panel.classList.remove('active'));
                clickedTab.classList.add('active');
                document.getElementById(`panel-${tabId}`).classList.add('active');
            }

            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                const bgColor = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-blue-500');
                toast.className = `fixed top-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg animate-pulse`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // --- INTERACTIVE QUESTS ---
            async function startInteractiveQuest(questId) {
                const quest = await api.startQuest(questId);
                if (!quest) {
                    showToast("Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu nhi·ªám v·ª• n√†y.", "error");
                    return;
                }
                activeInteractiveQuest = quest;
                modalTitle.textContent = quest.title;
                if (quest.type === 'quiz') buildQuiz(quest.data);
                else if (quest.type === 'puzzle') buildPuzzle(quest.data);
                else if (quest.type === 'journaling') buildJournaling(quest.data);
                else if (quest.type === 'breathing') buildBreathing(quest.data);
                openModal();
            }

            function openModal() {
                modalOverlay.classList.remove('hidden');
            }

            function closeModal() {
                modalOverlay.classList.add('hidden');
                modalContent.innerHTML = '';
                activeInteractiveQuest = null;
            }

            function buildQuiz(data) {
                let optionsHtml = data.options.map(opt =>
                    `<button class="w-full text-left p-3 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700" onclick="checkQuizAnswer(${opt.correct})">${opt.text}</button>`
                ).join('');
                modalContent.innerHTML = `
                    <p class="mb-4 text-gray-300">${data.question}</p>
                    <div class="space-y-2">${optionsHtml}</div>`;
            }

            function buildPuzzle(data) {
                modalContent.innerHTML = `
                    <p class="mb-2 text-gray-300">${data.question}</p>
                    <p class="text-2xl font-bold text-center tracking-widest my-4 text-white">${data.scrambled_word}</p>
                    <input id="puzzle-input" type="text" class="w-full p-2 border bg-gray-700 border-gray-600 text-white rounded-md" placeholder="Your answer...">
                    <button class="w-full mt-4 py-2 text-white font-bold bg-green-600 hover:bg-green-700 rounded-lg" onclick="checkPuzzleAnswer('${data.correct_answer}')">Submit</button>`;
            }

            function buildJournaling(data) {
                modalContent.innerHTML = `
                    <p class="mb-4 text-gray-300">${data.prompt}</p>
                    <textarea id="journal-input" rows="5" class="w-full p-3 border bg-gray-700 border-gray-600 text-white rounded-md focus:ring-2 focus:ring-blue-500" placeholder="H√£y vi·∫øt ra suy nghƒ© c·ªßa b·∫°n..."></textarea>
                    <button class="w-full mt-4 py-2 text-white font-bold bg-green-600 hover:bg-green-700 rounded-lg transition-colors" onclick="submitJournal()">Ho√†n Th√†nh</button>`;
            }

            function buildBreathing(data) {
                modalContent.innerHTML = `
                    <p id="breathing-instruction" class="mb-4 text-center text-2xl font-bold text-cyan-400 transition-opacity duration-500">Chu·∫©n b·ªã...</p>
                    <div class="w-40 h-40 mx-auto flex items-center justify-center">
                        <div id="breathing-circle" class="w-16 h-16 bg-cyan-500 rounded-full"></div>
                    </div>
                    <p class="text-center mt-4 text-gray-400">Th·ªùi gian c√≤n l·∫°i: <span id="breathing-timer">${data.duration_seconds}</span>s</p>
                    <button id="breathing-complete-btn" class="w-full mt-4 py-2 text-white font-bold bg-gray-600 rounded-lg cursor-not-allowed" disabled>Ho√†n Th√†nh</button>`;
                startBreathingAnimation(data.duration_seconds);
            }

            window.checkQuizAnswer = async function(isCorrect) {
                if (isCorrect) {
                    showToast('Ch√≠nh x√°c!', 'success');
                    await completeActiveQuest();
                } else {
                    showToast('Sai r·ªìi, th·ª≠ l·∫°i nh√©.', 'error');
                }
            }

            window.checkPuzzleAnswer = async function(correctAnswer) {
                const userInput = document.getElementById('puzzle-input').value;
                if (userInput.trim().toUpperCase() === correctAnswer.toUpperCase()) {
                    showToast('Ch√≠nh x√°c!', 'success');
                    await completeActiveQuest();
                } else {
                    showToast('Sai r·ªìi, th·ª≠ l·∫°i nh√©.', 'error');
                }
            }

            window.submitJournal = async function() {
                const input = document.getElementById('journal-input');
                if (input.value.trim().length < 10) {
                    showToast('H√£y vi·∫øt √≠t nh·∫•t 10 k√Ω t·ª± nh√©.', 'error');
                    return;
                }
                showToast('C·∫£m ∆°n b·∫°n ƒë√£ chia s·∫ª!', 'success');
                await completeActiveQuest();
            }

            function startBreathingAnimation(duration) {
                const circle = document.getElementById('breathing-circle');
                const instruction = document.getElementById('breathing-instruction');
                const timerEl = document.getElementById('breathing-timer');
                const completeBtn = document.getElementById('breathing-complete-btn');
                const states = ["H√≠t v√†o", "Gi·ªØ", "Th·ªü ra", "Gi·ªØ"];
                let stateIndex = 0;

                function animateState() {
                    instruction.textContent = states[stateIndex];
                    if (states[stateIndex] === "H√≠t v√†o") circle.style.transform = 'scale(2.5)';
                    else if (states[stateIndex] === "Th·ªü ra") circle.style.transform = 'scale(1)';
                    stateIndex = (stateIndex + 1) % 4;
                }
                setTimeout(() => {
                    animateState();
                    const animationInterval = setInterval(animateState, 4000);
                    let timeLeft = duration;
                    const timerInterval = setInterval(async () => {
                        timeLeft--;
                        timerEl.textContent = timeLeft;
                        if (timeLeft <= 0) {
                            clearInterval(animationInterval);
                            clearInterval(timerInterval);
                            instruction.textContent = "Ho√†n th√†nh!";
                            circle.style.transform = 'scale(1)';
                            completeBtn.disabled = false;
                            completeBtn.classList.replace('bg-gray-600', 'bg-green-600');
                            completeBtn.classList.replace('cursor-not-allowed', 'hover:bg-green-700');
                            completeBtn.onclick = () => completeActiveQuest();
                        }
                    }, 1000);
                }, 1000);
            }

            async function completeActiveQuest() {
                if (!activeInteractiveQuest) return;
                const data = await api.completeQuest(activeInteractiveQuest.id);
                if (data) {
                    renderPet(data.pet);
                    renderQuests(data.quests);
                    renderGold(data.gold);
                }
                closeModal();
            }

            // --- CHATBOT FUNCTIONS ---
            function openChat() {
                chatLog.innerHTML = '';
                addMessageToChatLog(`Ch√†o b·∫°n, t·ªõ l√† ${petNameText.textContent} ƒë√¢y! B·∫°n mu·ªën t√¢m s·ª± ƒëi·ªÅu g√¨?`, 'bot', {
                    pet_face: petElement.textContent,
                    pet_mood: moodText.textContent
                });
                chatModalOverlay.classList.remove('hidden');
                chatInput.focus();
            }

            function closeChat() {
                chatModalOverlay.classList.add('hidden');
            }

            function addMessageToChatLog(message, sender, petData = {}) {
                const messageContainer = document.createElement('div');
                messageContainer.className = 'chat-message-container';
                const messageBubble = document.createElement('div');
                messageBubble.className = 'w-fit max-w-xs p-3 rounded-lg break-words';
                messageBubble.textContent = message;

                if (sender === 'user') {
                    messageContainer.classList.add('user');
                    messageBubble.classList.add('bg-blue-600', 'text-white');
                    messageContainer.appendChild(messageBubble);
                } else {
                    const avatar = document.createElement('div');
                    avatar.className = 'chat-avatar bg-gray-700 border border-gray-600 text-cyan-400';
                    avatar.textContent = petData.pet_face || '...';
                    messageBubble.classList.add('bg-gray-600', 'text-white');
                    messageContainer.appendChild(avatar);
                    messageContainer.appendChild(messageBubble);
                    chatModalTitle.textContent = `Tr√≤ chuy·ªán v·ªõi ${petNameText.textContent} ${petData.pet_mood || ''}`;
                }
                chatLog.appendChild(messageContainer);
                chatLog.scrollTop = chatLog.scrollHeight;
            }

            async function handleSendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                addMessageToChatLog(message, 'user');
                chatInput.value = '';
                chatSendButton.disabled = true;
                petElement.textContent = 'O_O';

                const typingIndicator = document.createElement('div');
                typingIndicator.id = 'typing-indicator';
                typingIndicator.className = 'chat-message-container';
                typingIndicator.innerHTML = `
                    <div class="chat-avatar bg-gray-700 border border-gray-600 text-cyan-400">...</div>
                    <div class="p-3 rounded-lg bg-gray-600 text-gray-400">Pet is typing...</div>`;
                chatLog.appendChild(typingIndicator);
                chatLog.scrollTop = chatLog.scrollHeight;

                const data = await api.petChat(message);
                typingIndicator.remove();

                if (data && data.reply) {
                    addMessageToChatLog(data.reply, 'bot', data);
                } else {
                    addMessageToChatLog("T·ªõ g·∫∑p l·ªói r·ªìi, kh√¥ng th·ªÉ tr·∫£ l·ªùi...", 'bot', { pet_face: '(`-¬¥)' });
                }

                const latestData = await api.getGameData();
                if (latestData) renderPet(latestData.pet);
                chatSendButton.disabled = false;
            }


            // --- INITIALIZATION ---
            function init() {
                // Event Listeners
                tabButtons.forEach(btn => btn.addEventListener('click', handleTabClick));
                btnFeed.addEventListener('click', handleFeedClick);
                btnPlay.addEventListener('click', handlePlayClick);
                questList.addEventListener('click', handleQuestListClick);
                shopList.addEventListener('click', handleBuyItemClick);
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) closeModal()
                });
                modalCloseButton.addEventListener('click', closeModal);
                btnChat.addEventListener('click', openChat);
                chatCloseButton.addEventListener('click', closeChat);
                chatModalOverlay.addEventListener('click', (e) => {
                    if (e.target === chatModalOverlay) closeChat()
                });
                chatSendButton.addEventListener('click', handleSendMessage);
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleSendMessage()
                });

                // Initial data load
                loadGameData();
                renderShop();

                // Start pet's background actions loop
                setInterval(petActionLoop, 6000);
            }

            init();
        });
    </script>
</body>

</html>
