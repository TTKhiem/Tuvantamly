<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Dashboard - SoulMate</title>
    
    <!-- Tailwind CSS (D√πng cho layout nhanh) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Font Google -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: #FEFAE0; /* N·ªÅn kem ƒë·ªìng b·ªô */
            color: #344E41;
        }
        
        /* Hi·ªáu ·ª©ng thanh ch·ªâ s·ªë */
        .stat-bar-inner { transition: width 0.5s ease-in-out; }
        
        /* Khu v·ª±c nu√¥i Pet */
        #pet-container {
            background-image: url('https://img.freepik.com/free-vector/empty-room-with-window-sun-light_107791-2999.jpg');
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            border: 4px solid #A3B18A;
            box-shadow: 0 10px 30px rgba(52, 78, 65, 0.2);
        }

        /* Con Pet */
        #pet {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease-in-out;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; user-select: none; z-index: 5;
        }

        /* Skin Emoji */
        .skin-emoji {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            font-size: 7rem !important; /* To h∆°n ch√∫t cho d·ªÖ th∆∞∆°ng */
            filter: drop-shadow(0 8px 4px rgba(0,0,0,0.2));
            animation: breathe 3s infinite ease-in-out;
        }

        /* Skin M·∫∑c ƒë·ªãnh */
        .skin-default {
            width: 80px; height: 80px;
            border-radius: 50%;
            font-size: 2rem; font-weight: bold;
            background-color: #FFD6A5; 
            border: 4px solid #FF9F1C; 
            color: #D35400;
            box-shadow: 0 8px 20px rgba(255, 159, 28, 0.3);
            display: flex; align-items: center; justify-content: center;
        }

        @keyframes breathe {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        /* Level Up Animation */
        @keyframes levelUpAnimation {
            0% { transform: translate(-50%, -50%) scale(1) rotate(0deg); filter: brightness(1); }
            50% { transform: translate(-50%, -50%) scale(1.3) rotate(10deg); filter: brightness(1.2) drop-shadow(0 0 20px gold); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); filter: brightness(1); }
        }
        .level-up-animation { animation: levelUpAnimation 1.5s ease-in-out; }

        /* Bong b√≥ng chat */
        #speech-bubble {
            position: absolute;
            background: white;
            color: #344E41;
            border-radius: 1rem;
            padding: 0.8rem 1.2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateX(-50%);
            width: max-content; max-width: 250px;
            opacity: 0; transition: opacity 0.3s ease-in-out;
            pointer-events: none; z-index: 10;
            font-weight: 700; border: 2px solid #A3B18A;
            font-size: 0.95rem;
        }
        #speech-bubble.visible { opacity: 1; top: 30% !important; } /* Fix v·ªã tr√≠ bong b√≥ng */
        #speech-bubble::after {
            content: ''; position: absolute; bottom: -10px; left: 50%; 
            transform: translateX(-50%);
            border-width: 10px 10px 0; border-style: solid;
            border-color: white transparent transparent transparent;
        }

        /* UI Tabs & Buttons */
        .tab-button {
            transition: all 0.2s ease;
            color: #6C757D;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover { color: #588157; }
        .tab-button.active {
            color: #344E41;
            border-color: #588157;
            background-color: rgba(163, 177, 138, 0.2);
        }
        
        .tab-panel { display: none; animation: fadeIn 0.4s ease-in-out; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* N√∫t h√†nh ƒë·ªông (Action Buttons) */
        .action-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Modal Overlay */
        #quest-modal-overlay, #chat-modal-overlay {
            background-color: rgba(52, 78, 65, 0.7); /* Xanh ƒë·∫≠m m·ªù */
            backdrop-filter: blur(5px);
        }
        
        /* Chat UI */
        .chat-msg-bot { background-color: #E9EDC9; color: #344E41; border-radius: 12px 12px 12px 0; }
        .chat-msg-user { background-color: #588157; color: white; border-radius: 12px 12px 0 12px; }
    </style>
</head>

<body class="min-h-screen pb-10">

    <div class="container mx-auto p-4 max-w-6xl">

        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-white p-5 rounded-2xl shadow-sm mb-6 border border-gray-100">
            <div class="mb-4 md:mb-0 flex items-center gap-4">
                <a href="{{ url_for('home') }}" class="text-2xl font-extrabold text-[#344E41] flex items-center gap-2 hover:opacity-80 transition">
                    <i class="fas fa-arrow-left text-lg"></i> SoulMate
                </a>
                <div class="h-8 w-px bg-gray-300"></div>
                <div>
                    <h1 class="text-xl font-bold text-[#588157]">Nh√† c·ªßa Pet</h1>
                    <p class="text-sm text-gray-500">H√¥m nay {{ username }} th·∫ø n√†o?</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="flex items-center bg-[#FEFAE0] px-4 py-2 rounded-full border border-[#A3B18A]">
                    <span class="text-xl mr-2">ü™ô</span>
                    <span id="gold-text-header" class="text-[#BC4749] font-bold text-lg">Loading...</span>
                </div>
                <div class="w-10 h-10 rounded-full bg-[#A3B18A] flex items-center justify-center text-white font-bold border-2 border-white shadow-sm">
                    {{ username[0]|upper }}
                </div>
            </div>
        </header>

        <div class="bg-white p-6 rounded-3xl shadow-lg border border-gray-100 min-h-[600px]">

            <!-- NAVIGATION TABS -->
            <div class="border-b border-gray-200 mb-8 overflow-x-auto">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button data-tab="pet" class="tab-button active py-3 px-6 font-bold text-base rounded-t-xl flex items-center gap-2">
                        <i class="fas fa-home"></i> T·ªïng quan
                    </button>
                    <button data-tab="quests" class="tab-button py-3 px-6 font-bold text-base rounded-t-xl flex items-center gap-2">
                        <i class="fas fa-scroll"></i> Nhi·ªám V·ª•
                    </button>
                    <button data-tab="shop" class="tab-button py-3 px-6 font-bold text-base rounded-t-xl flex items-center gap-2">
                        <i class="fas fa-store"></i> C·ª≠a H√†ng
                    </button>
                    <button data-tab="inventory" class="tab-button py-3 px-6 font-bold text-base rounded-t-xl flex items-center gap-2">
                        <i class="fas fa-box-open"></i> T√∫i ƒê·ªì
                    </button>
                </nav>
            </div>

            <!-- CONTENT PANELS -->
            <div>
                
                <!-- 1. PET PANEL -->
                <div id="panel-pet" class="tab-panel active">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        <!-- C·ªôt Tr√°i: Pet Display (Chi·∫øm 7 ph·∫ßn) -->
                        <div class="lg:col-span-7 flex flex-col">
                            <div class="flex justify-between items-center mb-4 px-2">
                                <h3 class="text-2xl font-extrabold text-[#344E41]" id="pet-name">ƒêang t·∫£i...</h3>
                                <div class="flex items-center gap-2 bg-[#F0FDF4] px-3 py-1 rounded-full border border-green-200">
                                    <span class="text-green-600 font-bold text-sm">T√¢m tr·∫°ng:</span>
                                    <span id="mood-text" class="text-sm font-bold text-[#344E41]">Vui v·∫ª üòä</span>
                                </div>
                            </div>
                            
                            <div id="pet-container" class="w-full aspect-[4/3] rounded-3xl relative shadow-inner bg-gray-100 group">
                                <!-- Con Pet -->
                                <div id="pet" class="skin-default">^_^</div>
                                <!-- Bong b√≥ng chat -->
                                <div id="speech-bubble">Ch√†o c·∫≠u! T·ªõ nh·ªõ c·∫≠u l·∫Øm! ‚ù§Ô∏è</div>
                                
                                <!-- Hi·ªáu ·ª©ng hover nh·∫π -->
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-5 transition duration-500 rounded-3xl pointer-events-none"></div>
                            </div>
                        </div>

                        <!-- C·ªôt Ph·∫£i: Stats & Actions (Chi·∫øm 5 ph·∫ßn) -->
                        <div class="lg:col-span-5 flex flex-col justify-center space-y-6">
                            
                            <!-- Stats Card -->
                            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                                <h4 class="text-gray-400 font-bold mb-5 uppercase text-xs tracking-widest border-b pb-2">Ch·ªâ s·ªë s·ª©c kh·ªèe</h4>
                                
                                <!-- Happiness -->
                                <div class="mb-5">
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-[#BC4749] font-bold"><i class="fas fa-heart mr-1"></i> H·∫°nh ph√∫c</span>
                                        <span class="font-bold text-gray-600" id="happiness-val">50%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                        <div id="happiness-bar" class="stat-bar-inner bg-[#BC4749] h-3 rounded-full" style="width: 50%"></div>
                                    </div>
                                </div>

                                <!-- Energy -->
                                <div class="mb-5">
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-[#E9C46A] font-bold"><i class="fas fa-bolt mr-1"></i> NƒÉng l∆∞·ª£ng</span>
                                        <span class="font-bold text-gray-600" id="energy-val">100%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                        <div id="energy-bar" class="stat-bar-inner bg-[#E9C46A] h-3 rounded-full" style="width: 100%"></div>
                                    </div>
                                </div>

                                <!-- EXP -->
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-[#2A9D8F] font-bold">C·∫•p ƒë·ªô <span id="level-text" class="text-lg">1</span></span>
                                        <span class="text-xs text-gray-400 font-bold pt-1" id="exp-text">0/100 XP</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                        <div id="exp-bar" class="stat-bar-inner bg-[#2A9D8F] h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions Buttons -->
                            <div class="grid grid-cols-3 gap-4">
                                <button id="btn-feed" class="action-btn flex flex-col items-center justify-center p-4 bg-[#FFEDD5] hover:bg-[#FFDBA4] text-[#C2410C] rounded-2xl group">
                                    <span class="text-3xl mb-1 group-hover:scale-110 transition">üçï</span>
                                    <span class="text-sm font-bold">Cho ƒÉn</span>
                                    <span class="text-[10px] opacity-70">-10 V√†ng</span>
                                </button>
                                
                                <button id="btn-play" class="action-btn flex flex-col items-center justify-center p-4 bg-[#DBEAFE] hover:bg-[#BFDBFE] text-[#1D4ED8] rounded-2xl group">
                                    <span class="text-3xl mb-1 group-hover:scale-110 transition">üéæ</span>
                                    <span class="text-sm font-bold">Vui ch∆°i</span>
                                    <span class="text-[10px] opacity-70">+HP, -Energy</span>
                                </button>
                                
                                <button id="btn-chat" class="action-btn flex flex-col items-center justify-center p-4 bg-[#F3E8FF] hover:bg-[#E9D5FF] text-[#7E22CE] rounded-2xl group">
                                    <span class="text-3xl mb-1 group-hover:scale-110 transition">üí¨</span>
                                    <span class="text-sm font-bold">T√¢m s·ª±</span>
                                    <span class="text-[10px] opacity-70">AI Chat</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. QUESTS PANEL -->
                <div id="panel-quests" class="tab-panel">
                    <div class="flex justify-between items-end mb-6 border-b pb-4">
                        <div>
                            <h3 class="text-2xl font-extrabold text-[#344E41]">Nhi·ªám v·ª• h√¥m nay</h3>
                            <p class="text-gray-500 text-sm">Ho√†n th√†nh ƒë·ªÉ nh·∫≠n V√†ng v√† gi√∫p Pet l·ªõn nhanh!</p>
                        </div>
                    </div>
                    <div id="quest-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- JS Render -->
                        <div class="animate-pulse bg-gray-100 h-24 rounded-xl"></div>
                        <div class="animate-pulse bg-gray-100 h-24 rounded-xl"></div>
                    </div>
                </div>

                <!-- 3. SHOP PANEL -->
                <div id="panel-shop" class="tab-panel">
                    <div class="flex justify-between items-center mb-6 sticky top-0 bg-white z-10 py-3 border-b border-gray-100">
                        <h3 class="text-2xl font-extrabold text-[#344E41]">C·ª≠a H√†ng</h3>
                        <div class="flex items-center bg-[#FFF7ED] px-4 py-2 rounded-xl border border-orange-100">
                            <span class="text-xl mr-2">ü™ô</span>
                            <span id="gold-text-shop" class="text-[#C2410C] font-bold text-lg">0</span>
                        </div>
                    </div>
                    <div id="shop-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <!-- JS Render -->
                    </div>
                </div>

                <!-- 4. INVENTORY PANEL -->
                <div id="panel-inventory" class="tab-panel">
                    <h3 class="text-2xl font-extrabold text-[#344E41] mb-6">T√∫i ƒê·ªì C·ªßa B·∫°n</h3>
                    <div id="inventory-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <div class="col-span-full text-center py-20 bg-gray-50 rounded-2xl border border-dashed border-gray-300">
                            <p class="text-gray-400 font-bold">T√∫i ƒë·ªì ƒëang tr·ªëng tr∆°n...</p>
                            <button onclick="document.querySelector('[data-tab=shop]').click()" class="mt-4 px-6 py-2 bg-[#588157] text-white rounded-full text-sm font-bold hover:bg-[#3A5A40] transition">
                                ƒê·∫øn C·ª≠a H√†ng ngay
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- QUEST MODAL -->
    <div id="quest-modal-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md transform transition-all scale-100 relative">
            <button id="modal-close-button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-xl">&times;</button>
            
            <h2 id="modal-title" class="text-2xl font-bold text-[#344E41] mb-4 pr-8">Ti√™u ƒë·ªÅ nhi·ªám v·ª•</h2>
            <div id="modal-content" class="text-gray-600 leading-relaxed">
                <!-- N·ªôi dung quest -->
            </div>
        </div>
    </div>

    <!-- CHAT MODAL -->
    <div id="chat-modal-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg h-[80vh] flex flex-col overflow-hidden relative">
            
            <!-- Chat Header -->
            <div class="flex justify-between items-center p-5 bg-[#588157] text-white">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white text-[#588157] flex items-center justify-center text-xl">ü§ñ</div>
                    <div>
                        <h2 class="font-bold text-lg">Pet AI</h2>
                        <div class="flex items-center gap-1 text-xs opacity-90">
                            <span class="w-2 h-2 rounded-full bg-green-300 animate-pulse"></span> ƒêang l·∫Øng nghe
                        </div>
                    </div>
                </div>
                <button id="chat-close-button" class="text-white hover:bg-[#3A5A40] w-8 h-8 rounded-full flex items-center justify-center transition">&times;</button>
            </div>
            
            <!-- Chat Log -->
            <div id="chat-log" class="flex-grow p-5 space-y-4 overflow-y-auto bg-[#F9FAFB] scroll-smooth">
                <!-- Messages go here -->
                <div class="flex justify-center my-4 text-xs text-gray-400">--- B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán ---</div>
            </div>
            
            <!-- Chat Input -->
            <div class="p-4 bg-white border-t border-gray-100 flex items-center gap-3">
                <input type="text" id="chat-input" class="flex-grow p-4 bg-gray-50 border border-gray-200 text-gray-800 rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#588157] focus:border-transparent transition" placeholder="Nh·∫≠p tin nh·∫Øn...">
                <button id="chat-send-button" class="p-4 bg-[#588157] hover:bg-[#3A5A40] text-white rounded-2xl transition shadow-md flex-shrink-0">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ================= JAVASCRIPT ================= -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- VARIABLES ---
            let speechBubbleTimer;
            let previousLevel = 1;
            let activeInteractiveQuest = null;

            // --- SELECTORS ---
            const els = {
                pet: document.getElementById('pet'),
                petContainer: document.getElementById('pet-container'),
                bubble: document.getElementById('speech-bubble'),
                barHappy: document.getElementById('happiness-bar'),
                barEnergy: document.getElementById('energy-bar'),
                barExp: document.getElementById('exp-bar'),
                txtLevel: document.getElementById('level-text'),
                txtExp: document.getElementById('exp-text'),
                txtName: document.getElementById('pet-name'),
                txtMood: document.getElementById('mood-text'),
                txtGoldShop: document.getElementById('gold-text-shop'),
                txtGoldHeader: document.getElementById('gold-text-header'),
                
                listQuest: document.getElementById('quest-list'),
                listShop: document.getElementById('shop-list'),
                listInv: document.getElementById('inventory-list'),
                
                modalQuest: document.getElementById('quest-modal-overlay'),
                modalQuestTitle: document.getElementById('modal-title'),
                modalQuestContent: document.getElementById('modal-content'),
                
                modalChat: document.getElementById('chat-modal-overlay'),
                chatLog: document.getElementById('chat-log'),
                chatInput: document.getElementById('chat-input'),
                
                btns: {
                    feed: document.getElementById('btn-feed'),
                    play: document.getElementById('btn-play'),
                    chat: document.getElementById('btn-chat'),
                    sendChat: document.getElementById('chat-send-button'),
                    closeQuest: document.getElementById('modal-close-button'),
                    closeChat: document.getElementById('chat-close-button')
                },
                tabs: document.querySelectorAll('.tab-button'),
                panels: document.querySelectorAll('.tab-panel')
            };

            // --- API WRAPPER ---
            async function safeFetch(url, options = {}) {
                try {
                    const res = await fetch(url, options);
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || `L·ªói ${res.status}`);
                    }
                    return await res.json();
                } catch (e) {
                    console.error(e);
                    showToast(e.message, 'error');
                    return null;
                }
            }
            
            const api = {
                getData: () => safeFetch('/api/game_data'),
                petAction: () => safeFetch('/api/pet/action'),
                feed: () => safeFetch('/api/pet/feed', { method: 'POST' }),
                play: () => safeFetch('/api/pet/play', { method: 'POST' }),
                buy: (id) => safeFetch(`/api/shop/buy/${id}`, { method: 'POST' }),
                equip: (id) => safeFetch(`/api/pet/equip/${id}`, { method: 'POST' }),
                startQuest: (id) => safeFetch(`/api/start_quest/${id}`),
                completeQuest: (id) => safeFetch(`/api/complete_quest/${id}`, { method: 'POST' }),
                chat: (msg) => safeFetch('/api/pet/chat', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({message: msg})
                }),
                getShop: () => safeFetch('/api/shop/items')
            };

            // --- RENDER LOGIC ---
            function updateGold(amount) {
                els.txtGoldShop.textContent = amount;
                els.txtGoldHeader.textContent = amount;
            }

            function renderPet(pet) {
                if (!pet) return;

                if (pet.level > previousLevel) {
                    els.pet.classList.add('level-up-animation');
                    showToast(`Ch√∫c m·ª´ng! Pet l√™n c·∫•p ${pet.level}!`, 'success');
                    setTimeout(() => els.pet.classList.remove('level-up-animation'), 1500);
                }
                previousLevel = pet.level;

                els.barHappy.style.width = `${pet.happiness}%`;
                document.getElementById('happiness-val').textContent = `${pet.happiness}%`;
                
                els.barEnergy.style.width = `${pet.energy}%`;
                document.getElementById('energy-val').textContent = `${pet.energy}%`;
                
                const expPercent = Math.min(100, (pet.experience / pet.exp_to_next_level) * 100);
                if(els.barExp) els.barExp.style.width = `${expPercent}%`;
                
                els.txtLevel.textContent = pet.level;
                els.txtExp.textContent = `${pet.experience}/${pet.exp_to_next_level}`;
                els.txtName.textContent = pet.name;
                els.txtMood.textContent = pet.mood;

                // SKIN LOGIC
                els.pet.className = ''; 
                if (pet.appearance && pet.appearance.css_class) {
                    els.pet.classList.add(pet.appearance.css_class);
                    els.pet.textContent = pet.appearance.face;
                } else {
                    els.pet.classList.add('skin-default');
                    els.pet.textContent = '(‚Ä¢_‚Ä¢)';
                }

                // BACKGROUND LOGIC
                if (pet.background_url) {
                    els.petContainer.style.backgroundImage = `url('${pet.background_url}')`;
                }
            }

            function renderQuests(quests) {
                els.listQuest.innerHTML = '';
                if (!quests || !quests.length) {
                    els.listQuest.innerHTML = '<div class="col-span-full text-gray-400 text-center p-8 bg-gray-50 rounded-2xl">ƒê√£ ho√†n th√†nh h·∫øt nhi·ªám v·ª• h√¥m nay! Tuy·ªát v·ªùi! üéâ</div>';
                    return;
                }
                quests.forEach(q => {
                    const div = document.createElement('div');
                    div.className = `flex flex-col md:flex-row md:items-center justify-between p-5 rounded-2xl border transition shadow-sm ${q.completed ? 'bg-green-50 border-green-100' : 'bg-white border-gray-100 hover:shadow-md hover:border-[#A3B18A]'}`;
                    
                    let btn = '';
                    if (q.completed) {
                        btn = `<span class="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-bold text-sm flex items-center gap-1"><i class="fas fa-check"></i> ƒê√£ xong</span>`;
                    } else if (q.type === 'simple') {
                        btn = `<button data-id="${q.id}" class="btn-complete px-5 py-2.5 bg-[#588157] hover:bg-[#3A5A40] text-white rounded-xl font-bold text-sm transition shadow-sm transform hover:-translate-y-0.5">Xong ngay</button>`;
                    } else {
                        btn = `<button data-id="${q.id}" class="btn-start px-5 py-2.5 bg-[#2F3E46] hover:bg-black text-white rounded-xl font-bold text-sm transition shadow-sm transform hover:-translate-y-0.5">Th·ª±c hi·ªán</button>`;
                    }

                    div.innerHTML = `
                        <div class="mb-3 md:mb-0">
                            <h4 class="font-bold text-gray-800 text-lg ${q.completed ? 'line-through opacity-60' : ''}">${q.title}</h4>
                            <div class="flex items-center gap-3 mt-1">
                                <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded font-bold">+${q.reward_gold} V√†ng</span>
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">+${q.reward_exp} XP</span>
                            </div>
                        </div>
                        <div>${btn}</div>
                    `;
                    els.listQuest.appendChild(div);
                });
            }

            function renderShop(items) {
                els.listShop.innerHTML = '';
                if (!items) return;
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'bg-white border border-gray-100 rounded-2xl p-4 flex flex-col items-center text-center hover:shadow-lg transition duration-300 group relative overflow-hidden';
                    
                    div.innerHTML = `
                        <div class="absolute top-0 left-0 w-full h-1 bg-[#A3B18A] transform scale-x-0 group-hover:scale-x-100 transition duration-300"></div>
                        <div class="text-5xl mb-3 transform group-hover:scale-110 transition duration-300">${item.icon}</div>
                        <h4 class="font-bold text-gray-800 text-sm mb-1">${item.name}</h4>
                        <p class="text-xs text-gray-400 mb-4 h-8 overflow-hidden">${item.description || 'V·∫≠t ph·∫©m th√∫ v·ªã'}</p>
                        <button data-id="${item.id}" class="btn-buy w-full py-2 bg-[#BC4749] hover:bg-[#9B2226] text-white rounded-xl font-bold text-xs transition shadow-sm">
                            ${item.price} ü™ô Mua
                        </button>
                    `;
                    els.listShop.appendChild(div);
                });
            }

            function renderInventory(inv) {
                els.listInv.innerHTML = '';
                if (!inv || !inv.length) {
                    els.listInv.innerHTML = `
                        <div class="col-span-full text-center py-20 bg-gray-50 rounded-2xl border border-dashed border-gray-300">
                            <p class="text-gray-400 font-bold mb-4">T√∫i ƒë·ªì ƒëang tr·ªëng tr∆°n...</p>
                            <button onclick="document.querySelector('[data-tab=shop]').click()" class="px-6 py-2 bg-[#588157] text-white rounded-full text-sm font-bold hover:bg-[#3A5A40] transition shadow-md">
                                ƒê·∫øn C·ª≠a H√†ng ngay
                            </button>
                        </div>`;
                    return;
                }
                inv.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'bg-white border border-gray-100 rounded-2xl p-4 flex flex-col items-center text-center hover:shadow-md transition';
                    
                    let action = `<span class="text-xs text-gray-400 mt-3 block py-2">ƒê√£ d√πng</span>`;
                    if (item.type === 'skin' || item.type === 'background') {
                        action = `<button data-id="${item.id}" class="btn-equip mt-3 w-full py-2 bg-[#344E41] hover:bg-black text-white rounded-xl font-bold text-xs transition shadow-sm">Trang b·ªã</button>`;
                    }

                    div.innerHTML = `
                        <div class="text-4xl mb-2">${item.icon}</div>
                        <h4 class="font-bold text-gray-800 text-sm">${item.name}</h4>
                        <span class="text-[10px] uppercase tracking-wider text-gray-400 font-bold mt-1">${item.type}</span>
                        ${action}
                    `;
                    els.listInv.appendChild(div);
                });
            }

            // --- ACTIONS ---
            function showToast(msg, type = 'info') {
                const div = document.createElement('div');
                const bgColor = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-[#588157]' : 'bg-blue-500');
                div.className = `fixed bottom-5 right-5 px-6 py-3 rounded-xl text-white shadow-2xl z-50 transform transition-all duration-500 translate-y-10 opacity-0 ${bgColor} flex items-center gap-3`;
                div.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}"></i> ${msg}`;
                document.body.appendChild(div);
                
                requestAnimationFrame(() => {
                    div.classList.remove('translate-y-10', 'opacity-0');
                });
                setTimeout(() => {
                    div.classList.add('opacity-0', 'translate-y-10');
                    setTimeout(() => div.remove(), 500);
                }, 3000);
            }

            function showBubble(text) {
                if (speechBubbleTimer) clearTimeout(speechBubbleTimer);
                els.bubble.textContent = text;
                els.bubble.classList.add('visible');
                speechBubbleTimer = setTimeout(() => els.bubble.classList.remove('visible'), 4000);
            }

            async function refreshData() {
                const data = await api.getData();
                if (data) {
                    renderPet(data.pet);
                    renderQuests(data.quests);
                    renderInventory(data.inventory);
                    updateGold(data.gold);
                }
            }

            // --- EVENT DELEGATION ---
            document.body.addEventListener('click', async (e) => {
                const target = e.target;

                // Shop & Inventory
                if (target.closest('.btn-buy')) {
                    const id = target.closest('.btn-buy').dataset.id;
                    const res = await api.buy(id);
                    if (res) {
                        showToast(res.message || 'Mua th√†nh c√¥ng!', 'success');
                        renderInventory(res.inventory);
                        updateGold(res.gold);
                    }
                }
                if (target.closest('.btn-equip')) {
                    const id = target.closest('.btn-equip').dataset.id;
                    const res = await api.equip(id);
                    if (res) {
                        showToast('ƒê√£ thay ƒë·ªïi di·ªán m·∫°o!', 'success');
                        renderPet(res.pet);
                        document.querySelector('[data-tab="pet"]').click();
                    }
                }

                // Quests
                if (target.closest('.btn-complete')) {
                    const id = target.closest('.btn-complete').dataset.id;
                    const res = await api.completeQuest(id);
                    if (res) {
                        showToast('Ho√†n th√†nh nhi·ªám v·ª•! +V√†ng +XP', 'success');
                        renderPet(res.pet);
                        renderQuests(res.quests);
                        updateGold(res.gold);
                    }
                }
                if (target.closest('.btn-start')) {
                    const id = target.closest('.btn-start').dataset.id;
                    const quest = await api.startQuest(id);
                    if (quest) openQuestModal(quest);
                }
            });

            // Main Buttons
            els.btns.feed.onclick = async () => {
                const res = await api.feed();
                if (res) {
                    renderPet(res.pet);
                    updateGold(res.gold);
                    showToast('MƒÉm mƒÉm ngon qu√°! üçï', 'success');
                    showBubble('C·∫£m ∆°n c·∫≠u nha! ‚ù§Ô∏è');
                }
            };

            els.btns.play.onclick = async () => {
                const res = await api.play();
                if (res) {
                    renderPet(res.pet);
                    showToast('Vui qu√° ƒëi! üéæ', 'success');
                    showBubble('Hehe, vui th·∫≠t ƒë·∫•y!');
                }
            };

            // Chat Logic
            els.btns.chat.onclick = () => {
                els.chatLog.innerHTML = '<div class="flex justify-center my-4 text-xs text-gray-400">--- B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán ---</div>';
                addChatMsg("Ch√†o c·∫≠u! C·∫≠u mu·ªën t√¢m s·ª± chuy·ªán g√¨ n√†o?", 'bot', els.pet.textContent);
                els.modalChat.classList.remove('hidden');
                setTimeout(() => els.chatInput.focus(), 100);
            };
            
            els.btns.closeChat.onclick = () => els.modalChat.classList.add('hidden');
            
            els.btns.sendChat.onclick = async () => {
                const msg = els.chatInput.value.trim();
                if (!msg) return;
                
                addChatMsg(msg, 'user');
                els.chatInput.value = '';
                els.btns.sendChat.disabled = true;
                
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'text-gray-400 text-xs ml-2 animate-pulse italic mt-2';
                loadingDiv.id = 'chat-loading';
                loadingDiv.innerText = 'Pet ƒëang suy nghƒ©...';
                els.chatLog.appendChild(loadingDiv);
                els.chatLog.scrollTop = els.chatLog.scrollHeight;

                const res = await api.chat(msg);
                document.getElementById('chat-loading')?.remove();
                els.btns.sendChat.disabled = false;

                if (res && res.reply) {
                    addChatMsg(res.reply, 'bot', res.pet_face);
                }
                els.chatInput.focus();
            };
            
            els.chatInput.onkeypress = (e) => { if(e.key === 'Enter') els.btns.sendChat.click(); };

            function addChatMsg(txt, role, face) {
                const div = document.createElement('div');
                div.className = `flex items-end gap-3 mb-4 animate-[fadeIn_0.3s_ease-out] ${role === 'user' ? 'justify-end' : ''}`;
                
                if (role === 'bot') {
                    div.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-[#A3B18A] flex items-center justify-center text-lg flex-shrink-0 text-white border border-white shadow-sm">${face || 'ü§ñ'}</div>
                        <div class="chat-msg-bot p-3.5 text-sm shadow-sm max-w-[80%] leading-relaxed border border-gray-100 bg-white text-gray-800 rounded-2xl rounded-bl-none">
                            ${txt}
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="chat-msg-user p-3.5 text-sm shadow-md max-w-[80%] leading-relaxed bg-[#588157] text-white rounded-2xl rounded-br-none">
                            ${txt}
                        </div>
                    `;
                }
                els.chatLog.appendChild(div);
                els.chatLog.scrollTop = els.chatLog.scrollHeight;
            }

            // Interactive Quests (Modal)
            function openQuestModal(q) {
                activeInteractiveQuest = q;
                els.modalQuestTitle.textContent = q.title;
                els.modalQuestContent.innerHTML = ''; 
                els.modalQuest.classList.remove('hidden');

                if (q.type === 'quiz') {
                    q.data.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "w-full text-left p-4 mb-3 bg-gray-50 hover:bg-green-50 rounded-xl border border-gray-200 hover:border-green-300 transition font-medium text-gray-700";
                        btn.textContent = opt.text;
                        btn.onclick = () => {
                            if (opt.correct) { showToast('Ch√≠nh x√°c!', 'success'); finishQuest(); }
                            else showToast('Sai r·ªìi, th·ª≠ l·∫°i nh√©!', 'error');
                        };
                        els.modalQuestContent.appendChild(btn);
                    });
                } else if (q.type === 'journaling') {
                    els.modalQuestContent.innerHTML = `
                        <p class="mb-4 text-gray-500 italic bg-gray-50 p-3 rounded-lg border border-gray-100">"${q.data.prompt}"</p>
                        <textarea id="journal-in" class="w-full p-4 bg-white border border-gray-300 rounded-xl h-32 text-gray-800 focus:outline-none focus:ring-2 focus:ring-[#588157]" placeholder="Vi·∫øt suy nghƒ© c·ªßa b·∫°n..."></textarea>
                        <button id="journal-sub" class="w-full mt-4 py-3 bg-[#588157] text-white rounded-xl font-bold hover:bg-[#3A5A40] transition">L∆∞u nh·∫≠t k√Ω</button>
                    `;
                    document.getElementById('journal-sub').onclick = () => {
                        if (document.getElementById('journal-in').value.length > 5) { showToast('ƒê√£ l∆∞u!', 'success'); finishQuest(); }
                        else showToast('H√£y vi·∫øt d√†i h∆°n ch√∫t nh√©!', 'error');
                    };
                }
            }

            async function finishQuest() {
                if (activeInteractiveQuest) {
                    const res = await api.completeQuest(activeInteractiveQuest.id);
                    if (res) {
                        refreshData();
                        els.modalQuest.classList.add('hidden');
                        activeInteractiveQuest = null;
                    }
                }
            }

            els.btns.closeQuest.onclick = () => els.modalQuest.classList.add('hidden');

            // Tabs Logic
            els.tabs.forEach(btn => {
                btn.addEventListener('click', () => {
                    els.tabs.forEach(b => b.classList.remove('active'));
                    els.panels.forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(`panel-${btn.dataset.tab}`).classList.add('active');
                });
            });

            // Background Loop
            setInterval(async () => {
                const res = await api.petAction();
                if (res) {
                    renderPet(res);
                    if (res.action === 'motivate') showBubble(res.quote);
                    if (res.action === 'rest') showBubble(res.quote || 'Zzz...');
                }
            }, 8000);

            // Init
            refreshData();
            (async () => { renderShop(await api.getShop()); })();
        });
    </script>
</body>
</html>
