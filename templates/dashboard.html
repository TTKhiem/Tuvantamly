<!-- START OF FILE dashboard.html -->

{% extends "base.html" %}

{% block title %}Dashboard - Kh√¥ng gian c·ªßa t√¥i{% endblock %}

{% block head %}
<style>
    /* --- DASHBOARD STYLING --- */
    body {
        background-color: #FEFAE0; /* N·ªÅn kem ƒë·ªìng b·ªô */
        background-image: 
            radial-gradient(#A3B18A 0.5px, transparent 0.5px), 
            radial-gradient(#A3B18A 0.5px, #FEFAE0 0.5px);
        background-size: 30px 30px;
        background-position: 0 0, 15px 15px;
    }
    
    .dashboard-wrapper { padding: 30px 0 80px; }
    
    /* T·ªëi ∆∞u container ƒë·ªÉ full width */
    .dashboard-wrapper .container {
        max-width: 100% !important;
        padding-left: 20px;
        padding-right: 20px;
    }

    /* 1. PROFILE CARD (C·ªôt tr√°i) */
    .profile-card {
        background: white;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(52, 78, 65, 0.08);
        border: 1px solid rgba(255,255,255,0.5);
        position: sticky;
        top: 100px; /* D√≠nh khi cu·ªôn */
        min-height: 370px;
    }

    .profile-header-bg {
        height: 120px;
        background: linear-gradient(135deg, #344E41 0%, #588157 100%);
        position: relative;
    }

    .profile-avatar-container {
        position: relative;
        margin-top: -60px;
        text-align: center;
    }

    .profile-avatar {
        width: 120px; height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 5px solid white;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        background: white;
    }

    .profile-body { padding: 15px 30px 30px; text-align: center; }

    .user-badge {
        background: #F0FDF4;
        color: #588157;
        font-size: 0.8rem;
        font-weight: 700;
        padding: 5px 12px;
        border-radius: 20px;
        border: 1px solid #DCFCE7;
        display: inline-block;
        margin-top: 10px;
    }

    .stats-row {
        display: flex;
        justify-content: space-between;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #f0f0f0;
    }

    .stat-item h5 { margin: 0; font-weight: 800; color: #344E41; }
    .stat-item small { color: #999; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }

    /* 2. MAIN CONTENT (C·ªôt ph·∫£i) */
    
    /* Welcome Hero Section (NEW) */
    .welcome-hero {
        background: linear-gradient(135deg, #588157 0%, #344E41 100%);
        border-radius: 24px;
        padding: 25px 30px;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(52, 78, 65, 0.12);
        animation: slideInDown 0.8s ease-out;
        margin-bottom: 25px;
    }

    .welcome-hero-content {
        position: relative;
        z-index: 2;
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .welcome-emoji {
        font-size: 3.5rem;
        animation: float 3s ease-in-out infinite;
        flex-shrink: 0;
    }

    .welcome-text h2.welcome-greeting {
        font-family: 'Nunito', sans-serif;
        font-size: 1.5rem;
        font-weight: 800;
        margin: 0;
        margin-bottom: 5px;
        animation: fadeInUp 0.8s ease-out 0.2s both;
    }

    .welcome-text p.welcome-subtitle {
        font-size: 0.95rem;
        opacity: 0.9;
        margin: 0;
        font-weight: 500;
        animation: fadeInUp 0.8s ease-out 0.4s both;
    }

    .welcome-decoration {
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        opacity: 0.2;
    }

    .deco-circle {
        position: absolute;
        border: 3px solid white;
        border-radius: 50%;
    }

    .deco-1 {
        width: 150px;
        height: 150px;
        top: -50px;
        right: -30px;
        animation: rotate 20s linear infinite;
    }

    .deco-2 {
        width: 100px;
        height: 100px;
        top: 50%;
        right: 50px;
        animation: rotate 15s linear infinite reverse;
    }

    .deco-3 {
        width: 200px;
        height: 200px;
        bottom: -80px;
        right: -60px;
        animation: rotate 25s linear infinite;
    }

    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-15px); }
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Title Section */
    .dashboard-title {
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        color: #344E41;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Widget Card General */
    .widget-card {
        background: white;
        border-radius: 24px;
        padding: 25px;
        border: 1px solid rgba(0,0,0,0.03);
        box-shadow: 0 10px 25px rgba(0,0,0,0.03);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .widget-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(52, 78, 65, 0.1);
    }

    /* Match Status Widget (Active) */
    .match-card-active {
        background: linear-gradient(135deg, #344E41 0%, #3A5A40 100%);
        color: white;
        border: none;
    }
    
    .pulse-dot {
        width: 10px; height: 10px; background: #4ADE80; border-radius: 50%;
        display: inline-block; margin-right: 8px;
        box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
        animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
    }

    /* Pet Widget */
    .pet-preview-box {
        background: #FEFAE0;
        border-radius: 16px;
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px 0;
        border: 2px dashed #CCD5AE;
    }
    .pet-emoji-anim { 
        font-size: 4rem; 
        animation: bounce 3s infinite; 
        /* Th√™m text-shadow ƒë·ªÉ emoji n·ªïi l√™n tr√™n n·ªÅn ·∫£nh */
         text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    /* Animation cho qu·∫£ tr·ª©ng */
    @keyframes egg-wobble {
        0% { transform: rotate(0deg); }
        25% { transform: rotate(-5deg); }
        75% { transform: rotate(5deg); }
        100% { transform: rotate(0deg); }
    }
    .egg-anim {
        font-size: 5rem;
        animation: egg-wobble 2s infinite ease-in-out;
        cursor: pointer;
        transition: transform 0.3s;
    }
    .egg-anim:hover { transform: scale(1.1); }

    .progress-custom {
        height: 8px; border-radius: 10px; background-color: #eee; margin-top: 5px;
    }
    .progress-bar-custom { border-radius: 10px; }

    /* Quest List */
    .quest-item {
        padding: 12px 0;
        border-bottom: 1px solid #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .quest-item:last-child { border-bottom: none; }
    .quest-check-done { color: #588157; font-size: 1.1rem; }
    .quest-check-pending { color: #ddd; font-size: 1.1rem; }

    /* Popup Modal Styles */
    .wrapper-update {
        position: fixed; top: 50%; left: 50%;
        transform: translate(-50%, -50%) scale(0);
        width: 420px; background: white;
        border-radius: 24px; padding: 30px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.2);
        z-index: 2000; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .wrapper-update.active-popup { transform: translate(-50%, -50%) scale(1); }
    .overlay-update {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1999;
        display: none; backdrop-filter: blur(5px);
    }
    .overlay-update.active-popup { display: block; }

    /* Button Close Popup */
    .btn-close-popup {
        position: absolute; top: 15px; right: 15px;
        background: #f0f0f0; border: none; width: 32px; height: 32px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
    }
    .btn-close-popup:hover { background: #e0e0e0; }

    /* Hover effect cho n√∫t Chat AI - gi·ªØ ch·ªØ hi·ªÉn th·ªã */
    .btn-chat-ai {
        transition: all 0.3s ease;
        color: #344E41 !important;
    }
    .btn-chat-ai:hover {
        background: #FFFFFF !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        color: #344E41 !important;
    }

</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="container-fluid">
        <div class="row g-3">
            
            <!-- --- C·ªòT TR√ÅI: PROFILE CARD (Sticky) --- -->
            <div class="col-xl-3 col-lg-4">
                <div class="profile-card">
                    <div class="profile-header-bg"></div>
                    
                    <div class="profile-avatar-container">
                        <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=E9EDC9&color=344E41&bold=true&size=256" alt="User Avatar" class="profile-avatar">
                    </div>

                    <div class="profile-body">
                        <h3 class="fw-bold mb-0 text-dark">{{ user.username }}</h3>
                        <p class="text-muted small mb-2">{{ user.email }}</p>
                        
                        <div class="user-badge">
                            <i class="fas fa-seedling me-1"></i> {{ user.role | capitalize }}
                        </div>

                        {% if user.tags %}
                        <div class="mt-2">
                            <span class="badge bg-white text-secondary border rounded-pill fw-normal">{{ user.tags }}</span>
                        </div>
                        {% endif %}

                        <!-- Stats Grid -->
                        <div class="stats-row">
                            <div class="stat-item">
                                <h5>{{ user.gold or 0 }}</h5>
                                <small>V√†ng ü™ô</small>
                            </div>
                            <div class="stat-item">
                                <h5>{{ user.level or 1 }}</h5>
                                <small>C·∫•p ƒë·ªô ‚≠ê</small>
                            </div>
                            <div class="stat-item">
                                <h5>{{ user.date_joined.strftime('%Y-%m-%d') if user.date_joined else '2024' }}</h5>
                                <small>Tham gia üìÖ</small>
                            </div>
                        </div>

                        <!-- Edit Button -->
                        <button id="btnOpenUpdate" class="btn btn-outline-custom w-100 mt-4 rounded-pill">
                            <i class="fas fa-pen me-2"></i> C·∫≠p nh·∫≠t th√¥ng tin
                        </button>
                    </div>
                </div>
            </div>

            <!-- --- C·ªòT PH·∫¢I: WIDGETS & CONTENT (Expanded) --- -->
            <div class="col-xl-9 col-lg-8">
                
                <!-- ‚ú® WELCOME HERO SECTION (NEW) -->
                <div class="welcome-hero mb-3" id="welcomeHero" style="margin-bottom: 15px !important;">
                    <div class="welcome-hero-content">
                        <div class="welcome-emoji" id="welcomeEmoji">üëã</div>
                        <div class="welcome-text">
                            <h2 class="welcome-greeting" id="welcomeGreeting">Ch√†o bu·ªïi s√°ng</h2>
                            <p class="welcome-subtitle" id="welcomeSubtitle">{{ user.username }}! H√¥m nay s·∫Ω l√† m·ªôt ng√†y tuy·ªát v·ªùi.</p>
                        </div>
                    </div>
                    <div class="welcome-decoration">
                        <div class="deco-circle deco-1"></div>
                        <div class="deco-circle deco-2"></div>
                        <div class="deco-circle deco-3"></div>
                    </div>
                </div>

                <script>
                    // X√°c ƒë·ªãnh th·ªùi gian v√† hi·ªÉn th·ªã greeting ph√π h·ª£p
                    function updateWelcomeGreeting() {
                        const hour = new Date().getHours();
                        const welcomeGreeting = document.getElementById('welcomeGreeting');
                        const welcomeEmoji = document.getElementById('welcomeEmoji');
                        const welcomeSubtitle = document.getElementById('welcomeSubtitle');
                        
                        let greeting, emoji, subtitle;
                        
                        if (hour >= 5 && hour < 12) {
                            greeting = '‚òÄÔ∏è Ch√†o bu·ªïi s√°ng';
                            emoji = 'üåÖ';
                            subtitle = '{{ user.username }}! H√¥m nay s·∫Ω l√† m·ªôt ng√†y tuy·ªát v·ªùi.';
                        } else if (hour >= 12 && hour < 17) {
                            greeting = 'üå§Ô∏è Ch√†o bu·ªïi chi·ªÅu';
                            emoji = '‚ú®';
                            subtitle = '{{ user.username }}! B·∫°n ƒëang l√†m t·ªët l·∫Øm!';
                        } else if (hour >= 17 && hour < 21) {
                            greeting = 'üåÜ Ch√†o bu·ªïi t·ªëi';
                            emoji = 'üåô';
                            subtitle = '{{ user.username }}! H√£y th∆∞ gi√£n v√† chƒÉm s√≥c b·∫£n th√¢n.';
                        } else {
                            greeting = 'üåô Ch√†o bu·ªïi t·ªëi';
                            emoji = '‚≠ê';
                            subtitle = '{{ user.username }}! H√£y c√≥ m·ªôt gi·∫•c ng·ªß ngon.';
                        }
                        
                        welcomeGreeting.textContent = greeting;
                        welcomeEmoji.textContent = emoji;
                        welcomeSubtitle.textContent = subtitle;
                    }
                    
                    // C·∫≠p nh·∫≠t khi trang load
                    updateWelcomeGreeting();
                    
                    // C·∫≠p nh·∫≠t m·ªói ph√∫t
                    setInterval(updateWelcomeGreeting, 60000);
                </script>

                <!-- 1. MATCH STATUS (Tr·∫°ng th√°i k·∫øt n·ªëi) -->
                <div class="mb-3">
                    {% if current_match_code %}
                        <!-- TR·∫†NG TH√ÅI: ƒêANG C√ì PH√íNG CHAT -->
                        <div class="widget-card match-card-active d-flex align-items-center justify-content-between p-3">
                            <div>
                                <h6 class="fw-bold mb-1">
                                    <span class="pulse-dot"></span> Cu·ªôc tr√≤ chuy·ªán ƒëang di·ªÖn ra
                                </h6>
                                <p class="mb-0 opacity-75 small">Ph√≤ng: <strong>{{ current_match_code }}</strong></p>
                            </div>
                            <a href="{{ url_for('chat_room_view', room_code=current_match_code) }}" class="btn btn-light text-success fw-bold rounded-pill px-3 shadow" style="font-size: 0.85rem;">
                                Ti·∫øp t·ª•c <i class="fas fa-arrow-right ms-2"></i>
                            </a>
                        </div>
                    {% else %}
                        <!-- TR·∫†NG TH√ÅI: CH∆ØA C√ì PH√íNG -->
                        <div class="widget-card d-flex align-items-center justify-content-between p-4" style="background: #F0FDF4; border: 1px solid #DCFCE7;">
                            <div>
                                <h6 class="fw-bold mb-1 text-dark" style="font-size: 1.1rem;"><i class="fas fa-user-md text-success me-2"></i>B·∫°n c·∫ßn chia s·∫ª?</h6>
                                <p class="mb-0 text-muted small" style="font-size: 0.9rem;">C√°c chuy√™n gia s·∫µn s√†ng l·∫Øng nghe.</p>
                            </div>
                            <div class="d-flex gap-3">
                                <a href="{{ url_for('chat_interface') }}" class="btn btn-outline-custom btn-chat-ai rounded-pill bg-white" style="font-size: 0.95rem; padding: 9px 24px; font-weight: 600;">Chat AI</a>
                                <a href="{{ url_for('chat_home') }}" class="btn btn-primary-custom rounded-pill" style="font-size: 0.95rem; padding: 9px 24px; font-weight: 600;">T√¨m chuy√™n gia</a>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <div class="row g-3">
                    <!-- 2. PET WIDGET -->
                    <div class="col-md-4">
                        <div class="widget-card h-100 d-flex flex-column" style="padding: 15px; min-height: 370px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-paw text-warning me-2"></i>Pet</h6>
                                {% if pet %}
                                    <span class="badge bg-warning text-dark rounded-pill" style="font-size: 0.7rem;">{{ pet.mood }}</span>
                                {% endif %}
                            </div>

                            {% if pet %}
                                <!-- TR∆Ø·ªúNG H·ª¢P 1: ƒê√É C√ì PET -->
                                <div class="pet-preview-box" 
                                     style="height: 180px; 
                                            margin: 8px 0 15px 0;
                                            /* Ki·ªÉm tra n·∫øu c√≥ link ·∫£nh th√¨ m·ªõi set background image */
                                            {% if pet.background_url %}
                                                background-image: url('{{ pet.background_url }}');
                                                background-size: cover;
                                                background-position: center;
                                                background-repeat: no-repeat;
                                                border: 2px solid #CCD5AE; /* (T√πy ch·ªçn) ƒê·ªïi border th√†nh solid cho d·ªÖ nh√¨n h∆°n tr√™n n·ªÅn ·∫£nh */
                                            {% endif %}">
                                    
                                    <div class="pet-emoji-anim">
                                        {{ pet.appearance.face if pet.appearance else 'üê∂' }}
                                    </div>
                                </div>
                                
                                <div class="mt-auto">
                                    <h6 class="fw-bold text-center mb-2" style="font-size: 0.95rem;">{{ pet.name }}</h6>
                                    
                                    <div class="d-flex justify-content-between small text-muted mb-1" style="font-size: 0.75rem;">
                                        <span>NƒÉng l∆∞·ª£ng</span>
                                        <span>{{ pet.energy }}%</span>
                                    </div>
                                    <div class="progress progress-custom" style="height: 6px;">
                                        <div class="progress-bar progress-bar-custom bg-warning" style="width: {{ pet.energy }}%"></div>
                                    </div>

                                    <a href="{{ url_for('pet_page') }}" class="btn btn-primary-custom w-100 mt-2 btn-sm rounded-pill" style="font-size: 0.75rem;">
                                        ChƒÉm s√≥c
                                    </a>
                                </div>
                            {% else %}
                                <!-- TR∆Ø·ªúNG H·ª¢P 2: CH∆ØA C√ì PET (HI·ªÜN TR·ª®NG) -->
                                <div class="flex-grow-1 d-flex flex-column align-items-center justify-content-center text-center py-2">
                                    <div class="egg-anim mb-2" title="Ch·∫°m v√†o tr·ª©ng ƒë·ªÉ ·∫•p!" style="font-size: 3rem;">ü•ö</div>
                                    <h6 class="fw-bold text-dark" style="font-size: 0.9rem;">B·∫°n ch∆∞a c√≥ pet</h6>
                                    <p class="text-muted small mb-2" style="font-size: 0.75rem;">Nh·∫≠n nu√¥i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                                    
                                    <!-- N√∫t g·ªçi API Adopt -->
                                    <button id="btnAdoptPet" class="btn btn-primary-custom rounded-pill px-3" style="font-size: 0.75rem;">
                                        <i class="fas fa-magic me-2"></i>Nh·∫≠n nu√¥i
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 3. DAILY QUESTS -->
                    <div class="col-md-4">
                        <div class="widget-card h-100 d-flex flex-column" style="padding: 15px; min-height: 370px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-tasks text-info me-2"></i>Nhi·ªám v·ª•</h6>
                                <small class="text-muted" style="font-size: 0.7rem;">H√¥m nay</small>
                            </div>

                            <div class="d-flex flex-column gap-2 flex-grow-1" style="font-size: 0.95rem;">
                                {% if quests %}
                                    {% for quest in quests %}
                                    <div class="quest-item" style="padding: 10px 0; border-bottom: 1px solid #f5f5f5; margin-right: -25px; padding-right: 25px; display: flex; align-items: center; justify-content: space-between;">
                                        <span class="{% if quest.completed %}text-muted{% else %}fw-bold text-dark{% endif %}" style="font-size: 0.9rem; flex-grow: 1;">{{ quest.title }}</span>
                                        <div style="width: 20px; height: 20px; flex-shrink: 0; margin-left: 8px; display: flex; align-items: center; justify-content: center;">
                                            {% if quest.completed %}
                                                <i class="fas fa-check-circle text-success" style="font-size: 1rem; line-height: 1;"></i>
                                            {% else %}
                                                <i class="far fa-circle text-muted" style="font-size: 1rem; line-height: 1;"></i>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                    
                                    <div class="mt-auto text-center pt-2">
                                        <a href="{{ url_for('pet_page') }}" class="text-decoration-none small fw-bold text-primary" style="font-size: 0.8rem;">
                                            L√†m nhi·ªám v·ª• <i class="fas fa-arrow-right ms-1"></i>
                                        </a>
                                    </div>
                                {% else %}
                                    <div class="text-center py-2 text-muted small flex-grow-1 d-flex flex-column justify-content-center">
                                        <div>
                                            <i class="fas fa-mug-hot fs-4 mb-2 opacity-50"></i><br>
                                            <span style="font-size: 0.75rem;">Ch∆∞a c√≥ nhi·ªám v·ª•</span>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- 4. STREAKS & ACHIEVEMENTS (NEW) -->
                    <div class="col-md-4">
                        <div class="widget-card h-100 d-flex flex-column" style="padding: 15px; min-height: 370px;">
                            <h6 class="fw-bold mb-2 text-dark"><i class="fas fa-fire text-danger me-2"></i>Th√†nh t·ª±u</h6>
                            
                            <!-- STREAK SECTION (DYNAMIC) -->
                            {% if achievements %}
                            <div class="mb-3">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <small class="text-muted fw-bold" style="font-size: 0.8rem;">Chu·ªói Self-Care</small>
                                    <span class="badge bg-danger text-white rounded-pill" style="font-size: 0.7rem;">üî• {{ achievements.streak.current_streak }} ng√†y</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-danger" style="width: {{ achievements.streak.percentage }}%; border-radius: 4px;"></div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- ACHIEVEMENTS BADGES (DYNAMIC) -->
                            <div class="mb-auto">
                                <small class="text-muted fw-bold d-block mb-3" style="font-size: 0.95rem;">Huy hi·ªáu</small>
                                <div class="d-flex flex-wrap gap-2 justify-content-around">
                                    {% if achievements and achievements.all_badges %}
                                        {% for badge in achievements.all_badges %}
                                        <div class="d-flex flex-column align-items-center" title="{% if badge.unlocked %}ƒê√£ unlock{% else %}Ch∆∞a unlock: {{ badge.description }}{% endif %}">
                                            <div style="width: 80px; height: 80px; background: {{ badge.color }}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin-bottom: 10px; {% if not badge.unlocked %}opacity: 0.4;{% endif %} transition: 0.3s;">{{ badge.emoji }}</div>
                                            <span style="font-size: 0.8rem; text-center; {% if badge.unlocked %}color: #333;{% else %}color: #999;{% endif %};">{{ badge.name }}</span>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <!-- Fallback badges (static) -->
                                        <div class="d-flex flex-column align-items-center">
                                            <div style="width: 80px; height: 80px; background: #FFF3CD; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin-bottom: 10px;">üåü</div>
                                            <span style="font-size: 0.8rem; text-center; color: #666;">Kh·ªüi ƒë·∫ßu</span>
                                        </div>
                                        <div class="d-flex flex-column align-items-center">
                                            <div style="width: 80px; height: 80px; background: #DCE9F5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin-bottom: 10px; opacity: 0.4;">üí¨</div>
                                            <span style="font-size: 0.8rem; text-center; color: #999;">5 Cu·ªôc chat</span>
                                        </div>
                                        <div class="d-flex flex-column align-items-center">
                                            <div style="width: 80px; height: 80px; background: #DCF0E7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin-bottom: 10px; opacity: 0.4;">üéØ</div>
                                            <span style="font-size: 0.8rem; text-center; color: #999;">10 Quest</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- MOTIVATION CARD -->
                            <div class="mt-3 p-3 rounded-3" style="background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%); border-left: 3px solid #588157;">
                                <small class="text-dark fw-bold d-block mb-1" style="font-size: 0.8rem;">üí™ Ti·∫øp t·ª•c c·ªë g·∫Øng!</small>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    {% if achievements and achievements.streak.current_streak > 0 %}
                                        B·∫°n ƒëang ·ªü chu·ªói {{ achievements.streak.current_streak }} ng√†y. Tuy·ªát v·ªùi!
                                    {% else %}
                                        B·∫°n ƒëang tr√™n con ƒë∆∞·ªùng ph·ª•c h·ªìi tuy·ªát v·ªùi.
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-2 p-2 rounded-3 text-center" style="background: rgba(255,255,255,0.6); border: 1px dashed #A3B18A; font-size: 0.75rem;">
                    <p class="mb-0 fst-italic text-muted">
                        "H·∫°nh ph√∫c l√† h√†nh tr√¨nh ch√∫ng ta ƒëang ƒëi." üåø
                    </p>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- --- POPUP UPDATE PROFILE (MODAL) --- -->
<div class="overlay-update" id="overlayUpdate"></div>
<div class="wrapper-update" id="popupUpdate">
    <button class="btn-close-popup" id="btnCloseUpdate"><i class="fas fa-times"></i></button>
    
    <div class="text-center mb-4">
        <h4 class="fw-bold text-dark">C·∫≠p nh·∫≠t th√¥ng tin</h4>
        <p class="text-muted small">H√£y c·∫≠p nh·∫≠t ƒë·ªÉ ch√∫ng t√¥i hi·ªÉu b·∫°n h∆°n.</p>
    </div>

    <form action="{{ url_for('update_profile') }}" method="POST">
        <div class="mb-3">
            <label class="form-label small fw-bold text-muted">Ng√†y sinh</label>
            <input type="date" name="date_of_birth" class="form-control form-control-custom" value="{{ user.date_of_birth }}">
        </div>
        <div class="mb-3">
            <label class="form-label small fw-bold text-muted">S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="text" name="phone" class="form-control form-control-custom" value="{{ user.phone }}" placeholder="09xxxxxxx">
        </div>
        <div class="mb-4">
            <label class="form-label small fw-bold text-muted">ƒê·ªãa ch·ªâ</label>
            <input type="text" name="address" class="form-control form-control-custom" value="{{ user.address }}" placeholder="Th√†nh ph·ªë, Qu·∫≠n...">
        </div>
        <button type="submit" class="btn btn-primary-custom w-100">L∆∞u thay ƒë·ªïi</button>
    </form>
</div>

<!-- SCRIPT CHO POPUP & ADOPT PET & NEW WIDGETS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. Popup Update Logic
    const btnOpen = document.getElementById('btnOpenUpdate');
    const btnClose = document.getElementById('btnCloseUpdate');
    const popup = document.getElementById('popupUpdate');
    const overlay = document.getElementById('overlayUpdate');

    if (btnOpen) {
        btnOpen.addEventListener('click', () => {
            popup.classList.add('active-popup');
            overlay.classList.add('active-popup');
        });
    }

    const closePopup = () => {
        popup.classList.remove('active-popup');
        overlay.classList.remove('active-popup');
    };

    if (btnClose) btnClose.addEventListener('click', closePopup);
    if (overlay) overlay.addEventListener('click', closePopup);

    // 2. Logic Nh·∫≠n Nu√¥i Pet (G·ªçi API)
    const btnAdopt = document.getElementById('btnAdoptPet');
    if (btnAdopt) {
        btnAdopt.addEventListener('click', async () => {
            // Hi·ªáu ·ª©ng loading n√∫t
            const originalContent = btnAdopt.innerHTML;
            btnAdopt.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang ·∫•p...';
            btnAdopt.disabled = true;

            try {
                const response = await fetch('/api/pet/adopt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    // N·∫øu th√†nh c√¥ng, reload trang ƒë·ªÉ hi·ªán Pet
                    location.reload(); 
                } else {
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
                    btnAdopt.innerHTML = originalContent;
                    btnAdopt.disabled = false;
                }
            } catch (error) {
                console.error('L·ªói nh·∫≠n nu√¥i:', error);
                alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server.');
                btnAdopt.innerHTML = originalContent;
                btnAdopt.disabled = false;
            }
        });
    }
});
</script>
{% endblock %}
