<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulMate - Tr√≤ chuy·ªán t√¢m h·ªìn</title>
    
    <!-- Fonts: Playfair Display (Sang tr·ªçng) & Inter (Hi·ªán ƒë·∫°i) -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- GLOBAL SETUP --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            /* N·ªÅn: Deep Healing Green Gradient */
            background: radial-gradient(circle at center, #3A5A40 0%, #1A2F23 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #DAD7CD;
        }

        /* --- 1. THE SOUL ORB (LOGO M·ªöI - CSS PURE) --- */
        /* ƒê√¢y l√† qu·∫£ c·∫ßu √°nh s√°ng thay cho icon robot */
        .soul-orb-container {
            position: relative;
            width: 180px;
            height: 180px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 40px;
        }

        .soul-orb {
            width: 120px;
            height: 120px;
            background: radial-gradient(circle at 30% 30%, #A3B18A, #588157);
            border-radius: 50%;
            box-shadow: 
                0 0 60px rgba(163, 177, 138, 0.4), 
                inset 0 0 20px rgba(255, 255, 255, 0.5);
            /* Animation bi·∫øn h√¨nh */
            animation: morph 6s ease-in-out infinite;
            z-index: 2;
            position: relative;
        }

        .soul-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: spin 10s linear infinite;
        }
        
        .soul-ring::before {
            content: ''; position: absolute; top: -5px; left: 50%;
            width: 10px; height: 10px; background: #FFF; border-radius: 50%;
            box-shadow: 0 0 15px #FFF;
        }

        @keyframes morph {
            0% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; transform: scale(1); }
            50% { border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%; transform: scale(1.1); }
            100% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; transform: scale(1); }
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- 2. INTRO SCREEN (BANNER) --- */
        .intro-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            background: rgba(26, 47, 35, 0.85); /* N·ªÅn t·ªëi m·ªù */
            backdrop-filter: blur(10px);
            transition: all 1s cubic-bezier(0.77, 0, 0.175, 1);
        }

        .intro-content { text-align: center; max-width: 700px; padding: 20px; }

        .intro-title {
            font-family: 'Playfair Display', serif; /* Font sang tr·ªçng */
            font-size: 3.5rem;
            font-style: italic;
            font-weight: 400;
            color: #FFFFFF;
            margin-bottom: 20px;
            line-height: 1.2;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
            opacity: 0; 
            animation: fadeUp 1s ease-out forwards 0.5s;
        }

        .intro-subtitle {
            font-size: 1.1rem;
            color: #A3B18A;
            margin-bottom: 50px;
            font-weight: 300;
            letter-spacing: 0.5px;
            opacity: 0;
            animation: fadeUp 1s ease-out forwards 1s;
        }

        .btn-start-magic {
            background: transparent;
            color: #FFF;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 18px 50px;
            border-radius: 100px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            opacity: 0;
            animation: fadeUp 1s ease-out forwards 1.5s;
        }

        .btn-start-magic::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 0%; height: 100%;
            background: #DAD7CD;
            z-index: -1;
            transition: width 0.4s ease;
        }

        .btn-start-magic:hover {
            color: #1A2F23;
            border-color: #DAD7CD;
        }
        .btn-start-magic:hover::before { width: 100%; }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- 3. CHAT INTERFACE --- */
        .chat-wrapper {
            width: 1100px;
            height: 90vh;
            max-width: 95%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.5);
            display: flex;
            overflow: hidden;
            opacity: 0;
            transform: scale(0.95) translateY(50px);
            transition: all 1s cubic-bezier(0.16, 1, 0.3, 1);
            color: #333;
        }

        /* Active State */
        body.chat-active .intro-overlay {
            opacity: 0;
            pointer-events: none;
            filter: blur(20px);
        }

        body.chat-active .chat-wrapper {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        /* Sidebar */
        .chat-sidebar {
            width: 320px;
            background: #F8F9FA;
            border-right: 1px solid #EEE;
            padding: 40px 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Avatar nh·ªè trong sidebar c≈©ng l√† qu·∫£ c·∫ßu */
        .mini-orb {
            width: 80px; height: 80px;
            background: radial-gradient(circle at 30% 30%, #588157, #3A5A40);
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(88, 129, 87, 0.3);
            animation: morph 8s ease-in-out infinite;
        }

        .sidebar-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; color: #1A2F23; margin-bottom: 5px; }
        .sidebar-desc { color: #588157; font-size: 0.9rem; margin-bottom: 40px; }

        .btn-end {
            margin-top: auto;
            border: none;
            background: #BC4749;
            color: white;
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-end:hover { background: #9B2226; box-shadow: 0 5px 15px rgba(188, 71, 73, 0.3); }

        /* Main Chat */
        .chat-main { flex: 1; display: flex; flex-direction: column; background: white; }
        
        .chat-header {
            padding: 20px 40px;
            border-bottom: 1px solid #F0F0F0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .user-name { font-weight: 700; color: #1A2F23; font-size: 1.1rem; }

        .chat-window {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex; flex-direction: column; gap: 25px;
        }

        .message {
            max-width: 70%;
            padding: 18px 24px;
            font-size: 1rem;
            line-height: 1.6;
            animation: slideIn 0.4s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bot {
            align-self: flex-start;
            background: #F2F4F3;
            color: #333;
            border-radius: 24px 24px 24px 4px;
        }

        .user {
            align-self: flex-end;
            background: #344E41;
            color: white;
            border-radius: 24px 24px 4px 24px;
            box-shadow: 0 5px 15px rgba(52, 78, 65, 0.2);
        }

        /* Input */
        .input-area {
            padding: 30px 40px;
            border-top: 1px solid #F0F0F0;
            display: flex; gap: 15px;
        }
        .input-field {
            flex: 1;
            padding: 18px 25px;
            border-radius: 50px;
            border: 2px solid #EEE;
            background: #F9F9F9;
            font-size: 1rem;
            outline: none; transition: 0.3s;
        }
        .input-field:focus { border-color: #588157; background: white; }
        
        .btn-send {
            width: 60px; height: 60px;
            border-radius: 50%;
            background: #344E41;
            color: white; border: none; cursor: pointer;
            font-size: 1.2rem; transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-send:hover { background: #588157; transform: rotate(-10deg); }

        /* Typing Dot */
        .typing { display: none; margin-left: 20px; }
        .typing span { width: 6px; height: 6px; background: #999; display: inline-block; border-radius: 50%; margin: 0 2px; animation: bounce 1.4s infinite; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Responsive */
        @media(max-width: 768px) {
            .chat-wrapper { height: 100vh; border-radius: 0; }
            .chat-sidebar { display: none; }
            .intro-title { font-size: 2.5rem; }
        }
    </style>
</head>
<body>

    <!-- M√ÄN H√åNH INTRO (MAGIC) -->
    <div class="intro-overlay" id="introScreen">
        
        <!-- Qu·∫£ c·∫ßu linh h·ªìn -->
        <div class="soul-orb-container">
            <div class="soul-ring"></div>
            <div class="soul-orb"></div>
        </div>

        <div class="intro-content">
            <!-- C√¢u h·ªèi t√¢m l√Ω (D√πng font serif sang tr·ªçng) -->
            <h1 class="intro-title">
                H√¥m nay,<br>trong l√≤ng b·∫°n th·∫ø n√†o?
            </h1>
            
            <p class="intro-subtitle">
                ƒê·ª´ng gi·ªØ nh·ªØng g√°nh n·∫∑ng m·ªôt m√¨nh. <br>
                SoulMate ·ªü ƒë√¢y, l·∫Øng nghe v√† th·∫•u hi·ªÉu m·ªçi ƒëi·ªÅu b·∫°n n√≥i.
            </p>

            <button class="btn-start-magic" onclick="startChat()">
                Chia s·∫ª ngay <i class="fas fa-arrow-right ms-2"></i>
            </button>
        </div>
    </div>

    <!-- GIAO DI·ªÜN CHAT CH√çNH -->
    <div class="chat-wrapper">
        
        <!-- Sidebar -->
        <div class="chat-sidebar">
            <div class="mini-orb"></div>
            <h3 class="sidebar-title">SoulMate</h3>
            <span class="sidebar-desc">Ng∆∞·ªùi b·∫°n AI tri k·ª∑</span>

            <div style="width: 100%; text-align: left; padding-top: 20px; flex: 1;">
                <p style="margin-bottom: 15px; color: #555; font-size: 0.9rem;"><i class="fas fa-check-circle text-success me-2"></i> B·∫£o m·∫≠t tuy·ªát ƒë·ªëi</p>
                <p style="margin-bottom: 15px; color: #555; font-size: 0.9rem;"><i class="fas fa-check-circle text-success me-2"></i> L·∫Øng nghe 24/7</p>
                <p style="color: #555; font-size: 0.9rem;"><i class="fas fa-check-circle text-success me-2"></i> Ph√¢n t√≠ch c·∫£m x√∫c</p>
            </div>

            <button class="btn-end" onclick="endChat()">
                <i class="fas fa-save me-2"></i> L∆∞u & K·∫øt th√∫c
            </button>
        </div>

        <!-- Chat Area -->
        <div class="chat-main">
            <div class="chat-header">
                <span class="user-name">Ch√†o, {{ user }}</span>
                <span style="font-size: 0.85rem; color: #588157; background: #E9EDC9; padding: 5px 15px; border-radius: 20px; font-weight: 600;">
                    ‚óè Tr·ª±c tuy·∫øn
                </span>
            </div>

            <div class="chat-window" id="chat-window">
                <div class="message bot">
                    Xin ch√†o. M√¨nh l√† SoulMate. üåø<br>
                    C·∫£m ∆°n b·∫°n ƒë√£ tin t∆∞·ªüng m√¨nh. H√¥m nay c√≥ chuy·ªán g√¨ l√†m b·∫°n suy nghƒ© nhi·ªÅu kh√¥ng? H√£y c·ª© n√≥i ra nh√©.
                </div>
            </div>

            <div class="typing" id="typing">
                <span></span><span></span><span></span>
            </div>

            <form class="input-area" onsubmit="sendMessage(event)">
                <input type="text" id="msg-input" class="input-field" placeholder="Vi·∫øt nh·ªØng ƒëi·ªÅu b·∫°n ƒëang nghƒ©..." autocomplete="off">
                <button type="submit" class="btn-send"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>

<script>
    function startChat() {
        document.body.classList.add('chat-active');
        setTimeout(() => { document.getElementById('msg-input').focus(); }, 1000);
    }

    const chatWindow = document.getElementById('chat-window');
    const typingIndicator = document.getElementById('typing');

    async function sendMessage(e) {
        e.preventDefault();
        const input = document.getElementById('msg-input');
        const msg = input.value.trim();
        if (!msg) return;

        addMsg(msg, 'user');
        input.value = '';
        showTyping(true);

        try {
            const res = await fetch('/api/chat', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: msg })
            });
            const data = await res.json();
            showTyping(false);
            addMsg(data.response, 'bot');
        } catch (err) {
            showTyping(false);
            addMsg("K·∫øt n·ªëi gi√°n ƒëo·∫°n. Th·ª≠ l·∫°i sau nh√©.", 'bot');
        }
    }

    function addMsg(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.innerHTML = text;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showTyping(show) {
        typingIndicator.style.display = show ? 'block' : 'none';
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function endChat() {
        if(!confirm("B·∫°n mu·ªën k·∫øt th√∫c v√† l∆∞u l·∫°i nh·∫≠t k√Ω c·∫£m x√∫c n√†y ch·ª©?")) return;
        try {
            await fetch('/api/chat/complete', { method: 'POST' });
            document.body.style.opacity = 0; 
            document.body.style.transition = "1s";
            setTimeout(() => { window.location.href = "{{ url_for('home') }}"; }, 1000);
        } catch (e) {
            window.location.href = "{{ url_for('home') }}";
        }
    }
</script>

</body>
</html>
