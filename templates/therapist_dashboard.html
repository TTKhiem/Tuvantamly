<!-- START OF FILE templates/therapist_dashboard.html -->
{% extends "chat_base.html" %}

{% block title %}Góc Chuyên Gia | SoulMate Workstation{% endblock %}

{% block head %}
<style>
    /* --- 1. CORE PALETTE & VARIABLES --- */
    :root {
        /* Palette SoulMate - Healing Colors */
        --primary-dark: #344E41;    /* Rêu đậm (Text/Button/Highlights) */
        --primary-med: #588157;     /* Rêu vừa (Active/Icon) */
        --primary-light: #A3B18A;   /* Rêu sáng (Border/Accent) */
        --primary-sage: #DAD7CD;    /* Xám xanh (Inactive) */
        
        --bg-sage-tint: #F3F6F4;    /* Nền Chat: Xanh pha xám rất nhạt */
        --bg-cream: #FDFCF8;        /* Nền Panel: Kem giấy */
        --bg-card: #FFFFFF;         /* Nền Card nội dung */

        --glass-border: 1px solid rgba(163, 177, 138, 0.3);
        --shadow-soft: 0 4px 20px rgba(52, 78, 65, 0.05);
    }

    /* Fix Layout full màn hình - Override chat_base */
    .panel-left, .panel-right, .panel-center {
        height: calc(100vh - 90px) !important; 
        max-height: calc(100vh - 90px) !important;
        box-shadow: var(--shadow-soft);
        border: var(--glass-border);
    }

    /* --- 2. LEFT PANEL (DANH SÁCH) --- */
    .panel-left { 
        width: 280px !important; 
        background: rgba(253, 252, 248, 0.95); /* Nền kem đậm */
        display: flex; flex-direction: column;
    }

    /* Search Box Wrapper cũ (giữ lại input để chức năng search hoạt động nếu cần JS mở rộng sau này) */
    .search-box-wrapper {
        background: #fff;
        border-radius: 12px;
        padding: 8px 12px;
        border: 1px solid rgba(163, 177, 138, 0.3);
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        margin-top: 10px;
    }

    .patient-list-item {
        padding: 12px 15px;
        margin: 4px 10px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        display: flex; align-items: center; gap: 12px;
        background: transparent;
    }
    .patient-list-item:hover { 
        background: rgba(88, 129, 87, 0.08); /* Hover xanh nhạt */
    }
    
    /* Active State: Gradient nhẹ + Viền xanh */
    .patient-list-item.active {
        background: linear-gradient(to right, #ffffff, #F1F5F2);
        border-color: var(--primary-light);
        box-shadow: 0 4px 10px rgba(88, 129, 87, 0.1);
    }
    .patient-list-item.active h6 { color: var(--primary-dark); font-weight: 800; }

    .therapist-profile-footer {
        margin-top: auto; padding: 20px;
        background: #fff;
        border-top: 1px solid rgba(163, 177, 138, 0.2);
        display: flex; align-items: center; gap: 12px;
    }

    /* --- 3. CENTER PANEL (CHAT AREA) --- */
    .glass-panel.panel-center {
        /* Nền tổng thể của khung giữa */
        background: var(--bg-sage-tint); 
        display: flex; flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    /* HEADER */
    .workspace-header {
        /* Gradient trắng xuống xanh nhạt */
        background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(241, 245, 242, 0.9) 100%);
        backdrop-filter: blur(10px);
        padding: 15px 30px;
        border-bottom: 1px solid rgba(163, 177, 138, 0.2);
        display: flex; justify-content: space-between; align-items: center;
        z-index: 10;
    }

    /* VÙNG TIN NHẮN */
    .messages-area {
        flex: 1; overflow-y: auto; 
        padding: 30px;
        display: flex; flex-direction: column; gap: 18px;
        /* Màu nền chính: Xanh xám rất nhạt, dịu mắt */
        background-color: #F3F6F4; 
    }

    /* BUBBLES */
    .msg-bubble {
        max-width: 75%; padding: 14px 18px; 
        font-size: 0.95rem; line-height: 1.6; position: relative;
        word-wrap: break-word;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    
    /* Bubble Sinh viên */
    .msg-student {
        align-self: flex-start;
        background: #fff; 
        color: #333;
        border-radius: 18px 18px 18px 4px;
        border: 1px solid rgba(163, 177, 138, 0.3);
    }
    
    /* Bubble Chuyên gia */
    .msg-therapist {
        align-self: flex-end;
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-med) 100%);
        color: #fff;
        border-radius: 18px 18px 4px 18px;
        box-shadow: 0 4px 12px rgba(52, 78, 65, 0.15);
    }

    /* INPUT AREA */
    .workspace-input {
        padding: 20px; 
        background: #fff;
        border-top: 1px solid rgba(163, 177, 138, 0.15);
    }
    .input-box {
        background: #F1F5F2; /* Input nền xanh nhạt */
        border-radius: 30px;
        padding: 8px 20px; display: flex; align-items: center;
        transition: 0.3s; 
        border: 1px solid transparent;
    }
    .input-box:focus-within {
        background: #fff; 
        border-color: var(--primary-med);
        box-shadow: 0 4px 15px rgba(88, 129, 87, 0.1);
    }

    /* --- 4. RIGHT PANEL (AI) --- */
    .panel-right {
        width: 320px !important;
        background: rgba(253, 252, 248, 0.9);
        border-left: 1px solid rgba(163, 177, 138, 0.15);
        display: flex; flex-direction: column;
    }

    /* Orb Background Gradient */
    .orb-container {
        display: flex; flex-direction: column; align-items: center;
        padding: 30px 20px;
        background: linear-gradient(180deg, rgba(233, 237, 201, 0.3) 0%, rgba(255,255,255,0) 100%);
        border-bottom: 1px solid rgba(0,0,0,0.03);
    }

    /* ORB CSS */
    .soul-orb-mini {
        width: 70px; height: 70px;
        background: radial-gradient(circle at 30% 30%, #A3B18A, #344E41);
        border-radius: 50%;
        box-shadow: 
            0 0 20px rgba(163, 177, 138, 0.4),
            inset 2px 2px 5px rgba(255,255,255,0.4);
        animation: orbMorph 6s ease-in-out infinite alternate;
        position: relative;
        margin-bottom: 15px;
    }
    .soul-orb-mini::after {
        content: ''; position: absolute; top: 15%; left: 20%;
        width: 15px; height: 15px; background: rgba(255,255,255,0.3);
        border-radius: 50%; filter: blur(2px);
    }
    @keyframes orbMorph {
        0% { border-radius: 50%; transform: scale(1); }
        100% { border-radius: 40% 60% 60% 40% / 50% 50% 50% 50%; transform: scale(1.05); }
    }

    /* AI Cards */
    .ai-section-title {
        font-size: 0.75rem; font-weight: 800; color: #999;
        letter-spacing: 1px; text-transform: uppercase;
        margin: 20px 0 10px 5px; display: flex; align-items: center; gap: 8px;
    }
    
    .ai-card-modern {
        background: #fff;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 4px 15px rgba(52, 78, 65, 0.05);
        border: 1px solid rgba(163, 177, 138, 0.2);
        transition: transform 0.2s;
    }
    .ai-card-modern:hover { transform: translateY(-2px); }

    /* Summary List */
    .summary-item {
        display: flex; gap: 10px; margin-bottom: 12px;
        font-size: 0.9rem; color: #444; align-items: start;
    }
    .summary-icon {
        color: var(--primary-med); margin-top: 3px; font-size: 0.8rem;
    }

    /* --- [MOD] BEAUTIFUL SUGGESTION CHIPS --- */
    .suggestion-chip {
        background: #fff; 
        border: none;
        border-left: 4px solid #eee; /* Default border */
        border-radius: 8px; 
        padding: 14px; 
        margin-bottom: 12px;
        cursor: pointer; 
        transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
        text-align: left; 
        width: 100%;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        position: relative;
        overflow: hidden;
    }
    .suggestion-chip:hover {
        background: #fff; 
        transform: translateX(3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    /* Màu sắc riêng cho từng loại gợi ý */
    .chip-empathy { border-left-color: #E63946; } /* Đỏ dịu */
    .chip-question { border-left-color: #457B9D; } /* Xanh dương */
    .chip-safe { border-left-color: #2A9D8F; } /* Xanh ngọc */

    .chip-empathy:hover { background: #FFF5F5; }
    .chip-question:hover { background: #F0F7FA; }
    .chip-safe:hover { background: #F0FCFA; }

    .chip-label {
        font-size: 0.75rem; font-weight: 800; 
        display: flex; align-items: center; gap: 6px;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .chip-content {
        font-size: 0.9rem; color: #555; line-height: 1.4; display: block;
    }

    /* Nút search icon mới */
    .btn-icon-search {
        width: 32px; height: 32px;
        border-radius: 50%;
        background: #f1f1f1;
        color: var(--primary-dark);
        border: none;
        display: flex; align-items: center; justify-content: center;
        transition: 0.2s;
        text-decoration: none; /* QUAN TRỌNG: Để thẻ a không bị gạch chân */
    }
    .btn-icon-search:hover {
        background: var(--primary-med); color: #fff;
    }

    /* Button Tìm sinh viên mới - Style giống navbar */
    .btn-find-student {
        background: var(--primary-med); /* #588157 */
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(88, 129, 87, 0.2);
    }
    .btn-find-student:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(88, 129, 87, 0.3);
        color: #fff;
        text-decoration: none;
    }
    .btn-find-student:active {
        transform: translateY(0);
    }

</style>
{% endblock %}

{# --- 1. LEFT PANEL: LIST --- #}
{% block left_panel %}
<aside class="glass-panel panel-left animate__animated animate__fadeInLeft">
    <div class="p-4 pb-2">
        <!-- [MOD] Header with Button Find Student -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0" style="color: var(--primary-dark); font-family: 'Playfair Display', serif;">
                Hồ sơ tư vấn
            </h5>
        </div>
        
        <!-- Button Tìm sinh viên mới -->
        <a href="{{ url_for('chat_home') }}" class="btn-find-student mb-3">
            <i class="fas fa-user-plus"></i>
            <span>Tìm sinh viên mới</span>
        </a>
        
        <!-- Search input hidden but functional (Visual improved) -->
        <div class="search-box-wrapper d-flex align-items-center">
            <input type="text" class="border-0 w-100 small bg-transparent" placeholder="Nhập tên để lọc..." style="outline: none; color: #555;">
        </div>
    </div>
    
    <!-- ROOM LIST CONTAINER -->
    <div id="room-list-container" class="flex-grow-1 overflow-auto py-2">
        {% set chat_rooms = active_chat_rooms_json | from_json %}
        {% if chat_rooms %}
            {% for room in chat_rooms %}
            <div class="patient-list-item" 
                 data-room-code="{{ room.room_code }}" 
                 data-student-name="{{ room.student_name }}"
                 data-student-id="{{ room.student_id }}" onclick="switchRoom(this)">
                
                <div class="position-relative">
                    <img src="https://ui-avatars.com/api/?name={{ room.student_name }}&background=588157&color=fff&bold=true" 
                         class="rounded-3 shadow-sm" width="42" height="42">
                    <span class="position-absolute bottom-0 end-0 bg-success border border-white rounded-circle" 
                          style="width: 10px; height: 10px;"></span>
                </div>
                
                <div class="flex-grow-1 overflow-hidden">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-truncate" style="font-size: 0.95rem; color: #333;">{{ room.student_name }}</h6>
                        <span class="text-muted" style="font-size: 0.65rem;">Now</span>
                    </div>
                    <small class="text-muted d-block text-truncate mt-1" style="font-size: 0.75rem;">
                        {% if room.last_message %}
                            {{ room.last_message.message }}
                        {% else %}
                            <i class="fas fa-sparkles text-warning me-1"></i>Cuộc hội thoại mới
                        {% endif %}
                    </small>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5 text-muted opacity-50">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p class="small">Chưa có hồ sơ nào.</p>
            </div>
        {% endif %}
    </div>

    <!-- PROFILE FOOTER -->
    <div class="therapist-profile-footer">
        <img src="https://ui-avatars.com/api/?name={{ name }}&background=344E41&color=fff" class="rounded-circle shadow-sm" width="40" height="40">
        <div style="line-height: 1.2;">
            <div class="fw-bold" style="color: var(--primary-dark); font-size: 0.9rem;">{{ name }}</div>
            <small class="text-muted" style="font-size: 0.75rem;">Chuyên gia tâm lý</small>
        </div>
        
        <!-- [MOD] REMOVED LOGOUT BUTTON HERE AS REQUESTED -->
    </div>
</aside>
{% endblock %}


{# --- 2. CENTER PANEL: CHAT --- #}
{% block chat_content %}

<!-- VIEW 1: EMPTY STATE -->
<div id="empty-state-view" style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(243, 246, 244, 0.4);">
    <div class="mb-4 p-4 rounded-circle bg-white shadow-sm">
        <i class="fas fa-couch fa-3x" style="color: var(--primary-light);"></i>
    </div>
    <h3 class="fw-bold" style="color: var(--primary-dark); font-family: 'Playfair Display', serif;">Không gian làm việc</h3>
    <p class="text-muted small">Chọn hồ sơ bên trái để bắt đầu phiên tư vấn.</p>
</div>

<!-- VIEW 2: ACTIVE CHAT -->
<div id="active-chat-view" style="display: none; height: 100%; flex-direction: column;">
    <!-- Header -->
    <div class="workspace-header">
        <div class="d-flex align-items-center gap-3">
            <img src="" class="rounded-circle shadow-sm" width="45" height="45" id="header-avatar">
            <div>
                <h6 class="mb-0 fw-bold" style="color: var(--primary-dark);" id="header-student-name">Loading...</h6>
                <div class="d-flex align-items-center gap-2">
                    <!-- [MOD] Changed LIVE to ĐANG HOẠT ĐỘNG -->
                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-2" style="font-size: 0.65rem;">
                        <i class="fas fa-circle me-1" style="font-size: 6px; vertical-align: middle;"></i>ĐANG HOẠT ĐỘNG
                    </span>
                    <small class="text-muted" id="header-room-code" style="font-size: 0.7rem;">ID: --</small>
                </div>
            </div>
        </div>
        
        <form id="end-chat-form" action="{{ url_for('end_chat') }}" method="POST" onsubmit="return confirm('Kết thúc ca này?');">
            <input type="hidden" name="room_code" id="input-end-room-code">
            <button type="submit" class="btn btn-outline-danger btn-sm fw-bold rounded-pill px-3 shadow-sm">
                Kết thúc ca
            </button>
        </form>
    </div>

    <!-- Messages Area -->
    <div class="messages-area" id="messages-container">
        <!-- JS Render -->
    </div>

    <!-- Input -->
    <div class="workspace-input">
        <form id="chat-form" class="input-box">
            <button type="button" class="btn text-secondary rounded-circle p-2" title="Gửi ảnh"><i class="far fa-image"></i></button>
            <input type="text" id="msg-input" class="border-0 bg-transparent flex-grow-1 mx-2" placeholder="Nhập tin nhắn tư vấn..." autocomplete="off" style="outline: none;">
            <button type="submit" class="btn rounded-circle text-white shadow-sm p-2" style="background: var(--primary-dark); width: 40px; height: 40px;">
                <i class="fas fa-paper-plane fa-sm"></i>
            </button>
        </form>
    </div>
</div>
{% endblock %}


{# --- 3. RIGHT PANEL: AI (ORB + NEW UI) --- #}
{% block right_panel %}
<aside class="glass-panel panel-right animate__animated animate__fadeInRight">
    <div class="h-100 overflow-auto">
        
        <!-- SECTION 1: SOULMATE ORB -->
        <div class="orb-container">
            <div class="soul-orb-mini"></div>
            <h6 class="fw-bold mb-0" style="color: var(--primary-dark); letter-spacing: 1px;">SOULMATE AI</h6>
            <span class="badge bg-warning text-dark rounded-pill mt-1" style="font-size: 0.6rem; font-weight: 800;">ASSISTANT</span>
        </div>

        <div class="p-3">
            <div class="ai-section-title d-flex justify-content-between align-items-center">
                <span><i class="fas fa-clipboard-list"></i> Tóm tắt ca</span>
                <button class="btn btn-sm btn-outline-success border-0 py-0 px-2" 
                        onclick="triggerAnalysis()" 
                        title="Bấm để AI phân tích hồ sơ này ngay lập tức">
                    <i class="fas fa-bolt me-1"></i>Phân tích
                </button>
            </div>
            
            <div class="ai-card-modern">
                <ul class="list-unstyled mb-0" id="ai-summary-list">
                    <li class="text-center text-muted small py-4">
                        <i class="fas fa-brain fa-2x mb-2 opacity-50"></i><br>
                        Nhấn nút <b>"Phân tích"</b> ở trên<br>để AI đọc hồ sơ.
                    </li>
                </ul>
            </div>

            <!-- SECTION 3: BEAUTIFUL SUGGESTIONS -->
            <div class="ai-section-title mt-4">
                <i class="fas fa-magic text-warning"></i> Gợi ý phản hồi
                <i class="fas fa-sync-alt ms-auto text-muted cursor-pointer" 
                onclick="refreshAiSuggestions()" 
                title="Xóa cache và làm mới"
                style="font-size: 0.8rem;"></i>
            </div>
            
            <div id="ai-suggestions-area">
                <div class="text-center py-4">
                    <p class="text-muted small mb-3 opacity-75">
                        AI sẽ đọc tin nhắn của sinh viên<br>và gợi ý cách trả lời.
                    </p>
                    <button class="btn btn-sm btn-outline-primary rounded-pill px-3 shadow-sm" 
                            onclick="triggerManualSuggestions()">
                        <i class="fas fa-magic me-2"></i>Gợi ý câu trả lời
                    </button>
                </div>
            </div>
        </div>

    </div>
</aside>
{% endblock %}


{# --- 4. SCRIPTS (LOGIC GIỮ NGUYÊN) --- #}
{% block scripts %}
<script>
    let activeStudentId = null; // Biến lưu ID sinh viên hiện tại
    const suggestionCache = new Map(); // Cache gợi ý AI để đỡ tốn tiền gọi lại
    const summaryCache = new Map(); // Cache kết quả AI để đỡ tốn tiền gọi lại
    const ALL_ROOM_DATA = JSON.parse('{{ active_chat_rooms_json | safe }}');
    const INITIAL_MESSAGES = JSON.parse('{{ initial_messages_json | safe }}');
    const INITIAL_SUMMARY = JSON.parse('{{ initial_summary_json | safe }}');
    
    var socketio = io();
    const myUsername = "{{ name }}"; 
    
    const ui = {
        chatView: document.getElementById("active-chat-view"),
        emptyView: document.getElementById("empty-state-view"),
        container: document.getElementById("messages-container"),
        input: document.getElementById("msg-input"),
        name: document.getElementById("header-student-name"),
        avatar: document.getElementById("header-avatar"),
        endInput: document.getElementById("input-end-room-code"),
        roomCodeDisplay: document.getElementById("header-room-code"),
        summary: document.getElementById("ai-summary-list")
    };

    const historyCache = new Map();
    let activeRoomCode = null; 

    function toggleView(showChat) {
        if(showChat) {
            ui.emptyView.style.display = 'none';
            ui.chatView.style.display = 'flex'; 
        } else {
            ui.chatView.style.display = 'none';
            ui.emptyView.style.display = 'flex';
        }
    }

    // [JS LOGIC] Switch Room
    // [CODE ĐÃ TỐI ƯU HÓA]
    window.switchRoom = function(el) {
        const newCode = el.getAttribute('data-room-code');
        const sName = el.getAttribute('data-student-name');
        const sId = el.getAttribute('data-student-id'); 

        activeStudentId = sId;
        
        // 1. Xử lý UI Active
        document.querySelectorAll('.patient-list-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');

        activeRoomCode = newCode;
        ui.name.textContent = sName;
        ui.roomCodeDisplay.textContent = "ID: " + newCode;
        ui.avatar.src = `https://ui-avatars.com/api/?name=${sName}&background=588157&color=fff`;
        ui.endInput.value = newCode;
        
        toggleView(true);
        
        // 2. Xử lý Summary (Tóm tắt ca) - Check Cache
        if (summaryCache.has(newCode)) {
            renderAiSummary(summaryCache.get(newCode));
        } else {
            ui.summary.innerHTML = `
                <li class="text-center text-muted small py-4">
                    <i class="fas fa-brain fa-2x mb-2 opacity-25"></i><br>
                    Chưa có dữ liệu.<br>Nhấn nút <b>"Phân tích"</b> để tạo.
                </li>`;
        }

        // 3. Xử lý Suggestion (Gợi ý phản hồi) - Check Cache
        if (suggestionCache.has(newCode)) {
            renderSuggestions(suggestionCache.get(newCode));
        } else {
            resetSuggestionUI();
        }

        // 4. Xử lý Tin nhắn (Render Messages) - ĐÃ SỬA LỖI LẶP CODE
        ui.container.innerHTML = ''; 
        let currentMessages = [];

        // Ưu tiên 1: Lấy từ Cache phiên hiện tại
        if (historyCache.has(newCode)) {
            currentMessages = historyCache.get(newCode);
        } 
        // Ưu tiên 2: Lấy từ dữ liệu gốc server trả về (ALL_ROOM_DATA)
        else if (ALL_ROOM_DATA) {
             const rData = ALL_ROOM_DATA.find(r => r.room_code === newCode);
             if (rData && rData.messages) {
                 // Lưu vào cache ngay để lần sau dùng lại
                 historyCache.set(newCode, rData.messages);
                 currentMessages = rData.messages;
             }
        }

        // Render ra màn hình
        renderMessages(currentMessages);

        // 5. Kết nối Socket
        socketio.emit('join_room_request', { room_code: newCode });
    };

    function resetSuggestionUI() {
        const area = document.getElementById('ai-suggestions-area');
        area.innerHTML = `
            <div class="text-center py-4">
                <p class="text-muted small mb-3 opacity-75">
                    AI sẽ đọc tin nhắn của sinh viên<br>và gợi ý cách trả lời.
                </p>
                <button class="btn btn-sm btn-outline-primary rounded-pill px-3 shadow-sm" 
                        onclick="triggerManualSuggestions()">
                    <i class="fas fa-magic me-2"></i>Gợi ý câu trả lời
                </button>
            </div>`;
    }

    window.triggerManualSuggestions = function() {
        if (!activeRoomCode) {
            // Trường hợp chưa chọn phòng: Có thể dùng alert hoặc update UI tùy ý
            // Nhưng thường UI đã disable nút nếu chưa active phòng, nên alert ở đây tạm ổn
            alert("Vui lòng chọn phòng chat trước."); 
            return;
        }

        // Lấy lịch sử từ cache
        let fullHistory = historyCache.get(activeRoomCode) || [];
        
        // --- EDGE CASE 1: Lịch sử hoàn toàn trống ---
        if (fullHistory.length === 0) {
            showEmptyStateSuggestion("Chưa có tin nhắn nào trong cuộc hội thoại này.");
            return;
        }
        
        // --- LẤY CONTEXT (4 tin cuối) ---
        let recentContext = fullHistory.slice(-4); 

        // Tìm tin nhắn cuối cùng của SINH VIÊN
        let lastStudentMsg = null;
        for (let i = fullHistory.length - 1; i >= 0; i--) {
             if (fullHistory[i].name !== myUsername) {
                 lastStudentMsg = fullHistory[i].message;
                 break;
             }
        }

        // --- EDGE CASE 2: Có tin nhắn nhưng sinh viên chưa nói câu nào ---
        // (Ví dụ: Therapist vào chào hỏi trước liên tục)
        if (lastStudentMsg) {
            // Có tin nhắn -> Gọi AI bình thường
            fetchTherapistSuggestions(lastStudentMsg, recentContext);
        } else {
            // Không tìm thấy tin của sinh viên -> Hiển thị thông báo đẹp
            showEmptyStateSuggestion("Sinh viên chưa gửi tin nhắn nào để phân tích.");
        }
    };

    //Hiển thị thông báo lỗi đẹp trong khung AI
    function showEmptyStateSuggestion(message) {
        const area = document.getElementById('ai-suggestions-area');
        area.innerHTML = `
            <div class="text-center py-4 fade-in">
                <div class="text-muted small mb-3 opacity-75">
                    <i class="fas fa-comment-slash fa-2x mb-2"></i><br>
                    ${message}
                </div>
                <button class="btn btn-sm btn-outline-secondary rounded-pill px-3 shadow-sm" 
                        onclick="resetSuggestionUI()">
                    <i class="fas fa-undo me-1"></i>Quay lại
                </button>
            </div>`;
    }

    window.triggerAnalysis = function() {
        if (!activeRoomCode) {
            alert("Vui lòng chọn một hồ sơ trước.");
            return;
        }

        // Hiển thị loading
        ui.summary.innerHTML = `
            <li class="text-center text-muted small py-3">
                <i class="fas fa-circle-notch fa-spin me-2"></i>AI đang đọc hồ sơ...
            </li>`;

        // Gọi API (chỉ khi bấm nút này mới tốn request)
        fetchAiAnalysis(activeRoomCode, activeStudentId);
    }

    // --- HÀM MỚI: GỌI API PHÂN TÍCH ---
    function fetchAiAnalysis(roomCode, studentId) {
        fetch('/api/therapist/analyze_now', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ room_code: roomCode, student_id: studentId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                summaryCache.set(roomCode, data.summary);
                renderAiSummary(data.summary); // Cập nhật giao diện khi có kết quả
            } else {
                ui.summary.innerHTML = '<li class="text-danger small">Lỗi phân tích AI.</li>';
            }
        })
        .catch(err => {
            console.error(err);
            ui.summary.innerHTML = '<li class="text-danger small">Không thể kết nối Server AI.</li>';
        });
    }

    function renderMessages(msgs) {
        ui.container.innerHTML = '';
        if (!msgs || msgs.length === 0) {
            ui.container.innerHTML = '<div class="text-center mt-5 text-muted small opacity-50">Bắt đầu cuộc trò chuyện mới.</div>';
            return;
        }
        msgs.forEach(m => createMessageUI(m.name, m.message, m.timestamp, m.name === myUsername));
        scrollToBottom();
    }

    function createMessageUI(name, msg, timestamp, isOwn) {
        const time = timestamp ? timestamp.split(' ')[1] : new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const html = `
            <div class="msg-bubble ${isOwn ? 'msg-therapist' : 'msg-student'} animate__animated animate__fadeInUp animate__faster">
                <div>${msg}</div>
                <div class="msg-time">${time}</div>
            </div>`;
        ui.container.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
    }

    function scrollToBottom() {
        ui.container.scrollTop = ui.container.scrollHeight;
    }

    function renderAiSummary(data) {
        ui.summary.innerHTML = '';
        if (data && data.length > 0) {
            data.forEach(item => {
                ui.summary.innerHTML += `
                    <li class="summary-item">
                        <i class="fas fa-check-circle summary-icon"></i>
                        <span>${item.point}</span>
                    </li>`;
            });
        } else {
            ui.summary.innerHTML = '<li class="text-center text-muted small fst-italic py-3">Chưa có dữ liệu phân tích.</li>';
        }
    }

    window.fillInput = function(btn) {
        // [MOD] Updated to select from .chip-content to match new structure
        const text = btn.querySelector('.chip-content').innerText;
        ui.input.value = text;
        ui.input.focus();
    };

    // ===== HÀM LẤY GỢI Ý TỪ AI =====
    function fetchTherapistSuggestions(studentMsg, customContext = []) {
        if (!activeRoomCode) return;
        
        const area = document.getElementById('ai-suggestions-area');
        
        // Hiển thị Loading
        area.innerHTML = `
            <div class="text-center text-muted small py-4">
                <i class="fas fa-circle-notch fa-spin text-primary mb-2"></i><br>
                Đang phân tích...
            </div>`;

        // Nếu không truyền customContext thì fallback về lấy hết (đề phòng)
        const contextToSend = (customContext.length > 0) 
                              ? customContext 
                              : (historyCache.get(activeRoomCode) || []);
        
        fetch('/api/therapist/suggest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: studentMsg,
                context: contextToSend // Gửi 4 tin nhắn này xuống backend
            })
        })
        .then(res => res.json())
        .then(data => {
            // Lưu cache mới
            suggestionCache.set(activeRoomCode, data);
            renderSuggestions(data);
        })
        .catch(err => {
            console.error(err);
            // Nếu lỗi thì quay về nút bấm
            resetSuggestionUI();
            alert("Lỗi kết nối AI, vui lòng thử lại.");
        });
    }

    function renderSuggestions(suggestionsData) {
        const area = document.getElementById('ai-suggestions-area');
        if (!suggestionsData) return;
        
        let html = '';
        
        // Empathetic suggestion
        if (suggestionsData.empathetic) {
            html += `
                <button class="suggestion-chip chip-empathy" onclick="fillInput(this)">
                    <span class="chip-label text-danger"><i class="far fa-heart"></i> Thấu cảm</span>
                    <span class="chip-content">${suggestionsData.empathetic}</span>
                </button>`;
        }
        
        // Probing suggestion
        if (suggestionsData.probing) {
            html += `
                <button class="suggestion-chip chip-question" onclick="fillInput(this)">
                    <span class="chip-label text-primary"><i class="far fa-question-circle"></i> Khai thác</span>
                    <span class="chip-content">${suggestionsData.probing}</span>
                </button>`;
        }
        
        // CBT/Action suggestion
        if (suggestionsData.cbt_action) {
            html += `
                <button class="suggestion-chip chip-safe" onclick="fillInput(this)">
                    <span class="chip-label text-success"><i class="fas fa-shield-alt"></i> Hành động</span>
                    <span class="chip-content">${suggestionsData.cbt_action}</span>
                </button>`;
        }
        
        if (html) {
            area.innerHTML = html;
        }
    }

    window.refreshAiSuggestions = function() {
        if (!activeRoomCode) return;

        // 1. Xóa cache cũ
        suggestionCache.delete(activeRoomCode);
        
        // 2. Hiệu ứng xoay icon cho đẹp
        const icon = document.querySelector('.ai-section-title .fa-sync-alt');
        if(icon) {
            icon.classList.add('fa-spin');
            // Tắt xoay sau 1 giây (hoặc khi load xong, nhưng set cứng 1s cho mượt)
            setTimeout(() => icon.classList.remove('fa-spin'), 1000);
        }

        // 3. [QUAN TRỌNG] Tự động gọi lại AI ngay lập tức
        // Thay vì reset về nút bấm, ta gọi luôn hàm này để nó fetch dữ liệu mới
        triggerManualSuggestions();
    };

    document.getElementById("chat-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const msg = ui.input.value.trim();
        if(msg && activeRoomCode) {
            // Render message ngay lập tức
            createMessageUI(myUsername, msg, null, true);
            socketio.emit("message", { data: msg, room_code: activeRoomCode });
            
            // Lấy gợi ý AI cho tin nhắn mới nhất của sinh viên
            // Lưu message vào cache trước khi gọi API
            if(!historyCache.has(activeRoomCode)) historyCache.set(activeRoomCode, []);
            historyCache.get(activeRoomCode).push({name: myUsername, message: msg, timestamp: null});
            
            // Gọi API để lấy suggestions cho tin nhắn mới nhất của sinh viên (nếu có)
            // Tuy nhiên, chúng ta cần lắng nghe tin nhắn từ sinh viên trước
            
            ui.input.value = "";
        }
    });

    socketio.on("message", (data) => {
        if (data.room_code === activeRoomCode && data.name !== myUsername) {
            createMessageUI(data.name, data.message, data.timestamp, false);
            if(!historyCache.has(activeRoomCode)) historyCache.set(activeRoomCode, []);
            historyCache.get(activeRoomCode).push(data);
            
            resetSuggestionUI();
        }
    });

    socketio.on('room_history', (data) => {
        if(data.room_code === activeRoomCode) {
            historyCache.set(data.room_code, data.messages);
            renderMessages(data.messages);
        }
    });

    // ===== INITIALIZATION ON PAGE LOAD =====
    document.addEventListener('DOMContentLoaded', function() {
        if (ALL_ROOM_DATA && ALL_ROOM_DATA.length > 0) {
            // Lấy room code từ backend session (room mà therapist đang xem)
            const firstRoomCode = ALL_ROOM_DATA[0].room_code;
            const firstRoomEl = document.querySelector(`[data-room-code="${firstRoomCode}"]`);
            
            if (firstRoomEl) {
                // Set active state
                firstRoomEl.classList.add('active');
                
                // Set room data và load messages ngay (không cần gọi switchRoom)
                activeRoomCode = firstRoomCode;
                ui.name.textContent = firstRoomEl.getAttribute('data-student-name');
                ui.roomCodeDisplay.textContent = "ID: " + firstRoomCode;
                ui.avatar.src = `https://ui-avatars.com/api/?name=${ui.name.textContent}&background=588157&color=fff`;
                ui.endInput.value = firstRoomCode;
                
                toggleView(true);

                activeStudentId = firstRoomEl.getAttribute('data-student-id');
                
                // Load messages từ INITIAL_MESSAGES (dữ liệu từ backend)
                if (INITIAL_MESSAGES && INITIAL_MESSAGES.length > 0) {
                    historyCache.set(firstRoomCode, INITIAL_MESSAGES);
                    renderMessages(INITIAL_MESSAGES);
                } else {
                    ui.container.innerHTML = '<div class="text-center mt-5 text-muted small opacity-50">Bắt đầu cuộc trò chuyện mới.</div>';
                }
                
                // GỌI AI CHO PHÒNG ĐẦU TIÊN
                const sId = firstRoomEl.getAttribute('data-student-id');
                
                ui.summary.innerHTML = `
                <li class="text-center text-muted small py-4">
                    <i class="fas fa-brain fa-2x mb-2 opacity-25"></i><br>
                    Sẵn sàng.<br>Nhấn nút <b>"Phân tích"</b> để bắt đầu.
                </li>`;
                
                // // Gọi API
                // fetchAiAnalysis(firstRoomCode, sId);
                
                // Join socket room
                socketio.emit('join_room_request', { room_code: firstRoomCode });
            }
        } else {
            toggleView(false);
        }
    });

</script>   
{% endblock %}
