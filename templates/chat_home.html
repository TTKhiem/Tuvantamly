{% extends 'base.html' %} 

{% block title %}S·∫£nh K·∫øt N·ªëi - SoulMate{% endblock %}

{% block head %}
<style>
    /* --- 1. ATMOSPHERE BACKGROUND (Kh√¥ng gian) --- */
    .lobby-wrapper {
        position: relative;
        min-height: 85vh; /* Tr·ª´ ƒëi chi·ªÅu cao header/footer */
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        /* N·ªÅn Gradient ƒë·ªông d·ªãu m·∫Øt */
        background: radial-gradient(circle at top left, #F0FDF4, #FEFAE0, #E9EDC9);
    }

    /* C√°c ƒë·ªëm s√°ng tr√¥i l∆° l·ª≠ng (Ambient Lights) */
    .ambient-light {
        position: absolute;
        border-radius: 50%;
        filter: blur(60px);
        opacity: 0.6;
        z-index: 0;
        animation: floatLight 10s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
    }
    .light-1 { width: 300px; height: 300px; background: #A3B18A; top: -50px; left: -50px; animation-delay: 0s; }
    .light-2 { width: 400px; height: 400px; background: #D8F3DC; bottom: -100px; right: -50px; animation-delay: -5s; }
    
    @keyframes floatLight {
        0% { transform: translate(0, 0) scale(1); }
        100% { transform: translate(30px, 50px) scale(1.1); }
    }

    /* --- 2. GLASS PANEL (Khung ch√≠nh gi·ªØa) --- */
    .glass-panel-lobby {
        position: relative;
        width: 100%;
        max-width: 550px;
        background: rgba(255, 255, 255, 0.65);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.8);
        border-radius: 40px;
        padding: 50px 40px;
        box-shadow: 
            0 20px 50px rgba(52, 78, 65, 0.1),
            inset 0 0 0 1px rgba(255, 255, 255, 0.5);
        text-align: center;
        z-index: 10;
        transition: transform 0.4s ease;
    }

    /* --- 3. PULSING CORE (N√∫t T√¨m Ki·∫øm Trung T√¢m) --- */
    .core-container {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 40px auto;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-core {
        width: 100px; height: 100px;
        border-radius: 50%;
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        z-index: 5;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 15px 35px rgba(52, 78, 65, 0.3);
        
        /* Gradient Button (M√†u xanh ch·ªß ƒë·∫°o) */
        background: linear-gradient(135deg, #344E41 0%, #588157 100%);
        position: relative;
        outline: none;
    }

    .btn-core:hover { transform: scale(1.1); box-shadow: 0 20px 40px rgba(52, 78, 65, 0.4); }
    .btn-core:active { transform: scale(0.95); }

    /* Hi·ªáu ·ª©ng s√≥ng lan t·ªèa (Ripples) */
    .ripple {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        border: 1px solid #588157;
        opacity: 0;
        pointer-events: none;
        z-index: 1;
    }

    /* STATE: SEARCHING (Khi ƒëang t√¨m ki·∫øm) */
    /* ƒê·ªïi m√†u n√∫t sang ƒê·ªè/H·ªìng */
    .is-searching .btn-core {
        background: linear-gradient(135deg, #BC4749 0%, #E63946 100%); 
        animation: breathBtn 2s infinite ease-in-out;
        box-shadow: 0 15px 35px rgba(188, 71, 73, 0.3);
    }
    .is-searching .ripple { animation: rippleAnim 2.5s infinite linear; border-color: #BC4749; }
    .is-searching .ripple:nth-child(1) { animation-delay: 0s; }
    .is-searching .ripple:nth-child(2) { animation-delay: 0.8s; }
    .is-searching .ripple:nth-child(3) { animation-delay: 1.6s; }

    @keyframes breathBtn { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @keyframes rippleAnim {
        0% { width: 100px; height: 100px; opacity: 0.6; border-width: 4px; }
        100% { width: 350px; height: 350px; opacity: 0; border-width: 0px; }
    }

    /* --- 4. TYPOGRAPHY & TAGS --- */
    .lobby-title {
        font-family: 'Playfair Display', serif;
        font-weight: 700;
        color: #344E41;
        font-size: 2.2rem;
        margin-bottom: 10px;
    }

    .tag-container {
        display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px;
    }
    .tag-pill {
        background: rgba(255,255,255,0.6);
        border: 1px solid rgba(52, 78, 65, 0.1);
        color: #588157;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        font-family: 'Nunito', sans-serif;
    }

    /* --- 5. RESULT CARDS (K·∫øt qu·∫£ Match) --- */
    .match-card {
        background: #F0FDF4;
        border: 1px solid #BBF7D0;
        border-radius: 24px;
        padding: 25px;
        margin-top: 30px;
        text-align: left;
        display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    @keyframes slideUpFade {
        from { opacity: 0; transform: translateY(40px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Status Text */
    .status-text {
        height: 24px;
        transition: opacity 0.3s;
        font-family: 'Nunito', sans-serif;
    }

    /* Hi·ªáu ·ª©ng hover cho n√∫t H·ªßy */
    .hover-danger-bg:hover {
        background-color: #FEF2F2 !important;
        border-color: #F87171 !important;
        color: #DC2626 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="lobby-wrapper">
    <!-- Ambient Lights Background -->
    <div class="ambient-light light-1"></div>
    <div class="ambient-light light-2"></div>

    <div class="glass-panel-lobby">
        
        <!-- Header Section -->
        <div class="mb-2">
            <div class="d-inline-block p-3 rounded-circle bg-white shadow-sm text-success mb-3">
                <i class="fas fa-spa fa-2x"></i>
            </div>
            <h1 class="lobby-title">K·∫øt N·ªëi T√¢m H·ªìn</h1>
            <p class="text-muted" style="font-size: 0.95rem;">
                H·ªá th·ªëng s·∫Ω t√¨m ng∆∞·ªùi l·∫Øng nghe ph√π h·ª£p nh·∫•t v·ªõi tr·∫°ng th√°i c·∫£m x√∫c hi·ªán t·∫°i c·ªßa b·∫°n.
            </p>
        </div>

        <!-- Tags Section (Hi·ªÉn th·ªã ti√™u ch√≠ t√¨m ki·∫øm)
        <div class="tag-container">
            {% if user_tags %}
                {% for tag in user_tags %}
                    <span class="tag-pill"><i class="fas fa-hashtag me-1 opacity-50"></i>{{ tag }}</span>
                {% endfor %}
            {% else %}
                <span class="tag-pill">M·ªçi ch·ªß ƒë·ªÅ</span>
            {% endif %}
            <a href="{{ url_for('dashboard') }}" class="tag-pill bg-white text-secondary" style="border-style: dashed;" title="S·ª≠a Tags"><i class="fas fa-pen"></i></a>
        </div> -->

        <!-- THE CORE: N√∫t T√¨m Ki·∫øm Ch√≠nh -->
        <div id="core-wrapper" class="core-container">
            <!-- 3 V√≤ng s√≥ng (Ripples) -->
            <div class="ripple"></div>
            <div class="ripple"></div>
            <div class="ripple"></div>
            
            <!-- N√∫t B·∫•m -->
            <button id="btn-action" class="btn-core" title="Ch·∫°m ƒë·ªÉ b·∫Øt ƒë·∫ßu">
                <i id="icon-action" class="fas fa-search"></i>
            </button>
        </div>

        <!-- Status Display Text -->
        <div id="status-display" class="status-text fw-bold text-secondary mb-3">
            S·∫µn s√†ng k·∫øt n·ªëi...
        </div>

        <!-- RESULT AREA (S·∫Ω ƒë∆∞·ª£c JS ƒëi·ªÅn v√†o) -->
        <div id="match-result-area"></div>

        <!-- Footer Link -->
        <div class="mt-4 pt-3 border-top border-light border-opacity-50">
            <a href="{{ url_for('home') }}" class="text-secondary text-decoration-none small fw-bold">
                <i class="fas fa-arrow-left me-1"></i> Quay l·∫°i trang ch·ªß
            </a>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Socket.io Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io();
        
        // DOM Elements
        const btnAction = document.getElementById('btn-action');
        const iconAction = document.getElementById('icon-action');
        const coreWrapper = document.getElementById('core-wrapper');
        const statusText = document.getElementById('status-display');
        const matchArea = document.getElementById('match-result-area');
        
        let isSearching = false;

        // --- H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN ---
        function updateUIState(searching) {
            isSearching = searching;
            
            if (searching) {
                // Ch·∫ø ƒë·ªô T√¨m ki·∫øm: N√∫t ƒë·ªè, Icon X, S√≥ng radar
                coreWrapper.classList.add('is-searching');
                iconAction.className = 'fas fa-times'; 
                statusText.innerHTML = '<span class="text-success animate-pulse"><i class="fas fa-satellite-dish me-2 fa-spin"></i>ƒêang qu√©t t·∫ßn s·ªë c·∫£m x√∫c...</span>';
                matchArea.style.display = 'none'; // ·∫®n k·∫øt qu·∫£ c≈©
            } else {
                // Ch·∫ø ƒë·ªô Ch·ªù: N√∫t xanh, Icon Search
                coreWrapper.classList.remove('is-searching');
                iconAction.className = 'fas fa-search'; 
                statusText.innerHTML = '<span>S·∫µn s√†ng k·∫øt n·ªëi...</span>';
            }
        }

        // --- S·ª∞ KI·ªÜN CLICK N√öT TRUNG T√ÇM ---
        btnAction.addEventListener('click', () => {
            if (!isSearching) {
                // B·∫Øt ƒë·∫ßu t√¨m
                socket.emit("find_match");
                updateUIState(true);
            } else {
                // H·ªßy t√¨m
                socket.emit("cancel_match");
                updateUIState(false);
                statusText.innerHTML = '<span class="text-muted">ƒê√£ h·ªßy t√¨m ki·∫øm.</span>';
            }
        });

        // --- SOCKET EVENT LISTENERS ---

        // 1. X·ª≠ l√Ω L·ªñI ho·∫∑c ƒêANG C√ì PH√íNG (Fix L·ªói Zombie Match)
        socket.on("match_error", (data) => {
            updateUIState(false);
            
            if (data.action === "redirect_to_active_room" && data.room_code) {
                // Render Card C·∫£nh B√°o + N√∫t H·ªßy
                matchArea.innerHTML = `
                    <div class="match-card d-block" style="background: #FFFBF0; border: 1px solid #FDE68A;">
                        <div class="d-flex align-items-start">
                            <div class="p-2 bg-warning bg-opacity-10 rounded-circle me-3 text-warning">
                                <i class="fas fa-exclamation-triangle fs-4"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold text-dark mb-1">B·∫°n ƒëang c√≥ cu·ªôc tr√≤ chuy·ªán</h6>
                                <p class="small mb-2 text-muted" style="line-height: 1.4;">
                                    H·ªá th·ªëng ghi nh·∫≠n b·∫°n ƒëang ·ªü ph√≤ng <strong>${data.room_code}</strong>. 
                                    B·∫°n mu·ªën quay l·∫°i hay k·∫øt th√∫c n√≥?
                                </p>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-3">
                            <!-- N√∫t 1: C·ªë g·∫Øng v√†o l·∫°i -->
                            <button id="btn-rejoin" class="btn btn-warning text-dark fw-bold shadow-sm py-2 rounded-pill" style="border: 1px solid rgba(0,0,0,0.05);">
                                <i class="fas fa-sign-in-alt me-2"></i>Quay l·∫°i ph√≤ng chat
                            </button>

                            <!-- N√∫t 2: H·ªßy k√®o (Force End) -->
                            <form action="{{ url_for('end_chat') }}" method="POST" style="margin:0;">
                                <input type="hidden" name="room_code" value="${data.room_code}">
                                <button type="submit" class="btn btn-light text-danger w-100 fw-bold py-2 rounded-pill hover-danger-bg transition" 
                                        style="border: 1px solid #FECACA; background: #FEF2F2;"
                                        onclick="if(!confirm('H√†nh ƒë·ªông n√†y s·∫Ω ng·∫Øt k·∫øt n·ªëi ngay l·∫≠p t·ª©c ƒë·ªÉ b·∫°n c√≥ th·ªÉ t√¨m ng∆∞·ªùi m·ªõi.\\n\\nB·∫°n ch·∫Øc ch·∫Øn ch·ª©?')) return false; this.innerHTML='<i class=\'fas fa-spinner fa-spin me-2\'></i>ƒêang x·ª≠ l√Ω...';">
                                    <i class="fas fa-unlink me-2"></i>R·ªùi ph√≤ng & T√¨m m·ªõi
                                </button>
                            </form>
                        </div>
                    </div>
                `;
                matchArea.style.display = 'block';
                
                // G·∫Øn s·ª± ki·ªán cho n√∫t Rejoin
                document.getElementById('btn-rejoin').addEventListener('click', function() {
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang v√†o l·∫°i...';
                    this.disabled = true;
                    socket.emit("join_private_room", { room_code: data.room_code });
                });

            } else {
                // L·ªói th√¥ng th∆∞·ªùng (v√≠ d·ª•: Server l·ªói)
                statusText.innerHTML = `<span class="text-danger fw-bold"><i class="fas fa-exclamation-circle me-1"></i>${data.message}</span>`;
            }
        });

        // 2. T√åM TH·∫§Y MATCH TH√ÄNH C√îNG
        socket.on("match_found", (data) => {
            // T·∫Øt ch·∫ø ƒë·ªô t√¨m ki·∫øm nh∆∞ng gi·ªØ UI ƒë·∫∑c bi·ªát (·∫©n n√∫t t√¨m ƒëi)
            coreWrapper.classList.remove('is-searching');
            btnAction.style.display = 'none'; 
            coreWrapper.style.display = 'none'; 
            
            statusText.innerHTML = '<span class="text-success fw-bold">K·∫øt n·ªëi th√†nh c√¥ng! üéâ</span>';

            const partnerName = data.matched_with || "Ng∆∞·ªùi b·∫°n b√≠ ·∫©n";
            
            // Render Card K·∫øt Qu·∫£
            matchArea.innerHTML = `
                <div class="match-card d-block">
                    <div class="text-center mb-4">
                        <div class="d-inline-flex p-3 rounded-circle bg-white shadow-sm mb-3">
                            <img src="https://ui-avatars.com/api/?name=${partnerName}&background=A3B18A&color=fff" class="rounded-circle shadow-sm" width="64" height="64">
                        </div>
                        <h5 class="fw-bold text-dark mb-0">ƒê√£ t√¨m th·∫•y b·∫°n ƒë·ªìng h√†nh</h5>
                        <small class="text-muted">S·∫µn s√†ng l·∫Øng nghe b·∫°n</small>
                    </div>

                    <div class="bg-white p-3 rounded-4 border mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small text-muted fw-bold">Ng∆∞·ªùi tham gia</span>
                            <span class="small fw-bold text-success">${partnerName}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="small text-muted fw-bold">M√£ ph√≤ng</span>
                            <span class="small fw-bold text-dark bg-light px-2 rounded">${data.room_code}</span>
                        </div>
                    </div>

                    <button id="btn-join" class="btn btn-primary-custom w-100 py-3 shadow">
                        V√†o ph√≤ng ngay <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            `;
            matchArea.style.display = 'block';

            // S·ª± ki·ªán Click Join - Redirect kh√°c nhau t√πy theo role
            document.getElementById('btn-join').addEventListener('click', function() {
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang k·∫øt n·ªëi...';
                this.disabled = true;
                
                // Ki·ªÉm tra redirect_to flag
                if (data.redirect_to === 'therapist_dashboard') {
                    // Therapist ‚Üí Redirect t·ªõi therapist_dashboard + room_code
                    window.location.href = `{{ url_for('therapist_dashboard_redirect') }}?room=${data.room_code}`;
                } else {
                    // Student ‚Üí S·ª≠ d·ª•ng join_private_room b√¨nh th∆∞·ªùng
                    socket.emit("join_private_room", { room_code: data.room_code });
                }
            });
        });

        // 3. CHUY·ªÇN H∆Ø·ªöNG T·ªöI PH√íNG CHAT
        socket.on("redirect_to_room", (data) => {
            window.location.href = data.url;
        });
    });
</script>
{% endblock %}
